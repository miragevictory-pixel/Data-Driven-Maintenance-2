<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maintenance Portal</title>

  <style>
    :root{
      --brand:#9e2f1c;
      --bg:#fff9f7;
      --text:#1e1e1e;
      --muted:#6b6b6b;
      --card:#ffffff;
      --radius:18px;
      --shadow:0 6px 18px rgba(0,0,0,.12);
    }
    * , *::before, *::after{ box-sizing:border-box; }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "TH Sarabun New", Tahoma, sans-serif;
      color:var(--text);
      background:var(--bg);
      font-size:16px;
      line-height:1.45;
    }

    /* ====== Top Bar ====== */
    .topbar{
      position:sticky; top:0; z-index:20;
      background:var(--brand); color:#fff; padding:14px 16px;
      display:flex; align-items:center; gap:10px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    .topbar h1{font-size:20px; margin:0; font-weight:700; letter-spacing:.3px}
    .back{appearance:none; background:transparent; border:0; color:#fff; font-size:18px; cursor:pointer}

    .container{max-width:420px; margin:0 auto; padding:18px 16px 72px}
    @media (min-width: 640px){ .container{ max-width: 720px; } }
    @media (min-width: 1024px){ .container{ max-width: 1100px; padding-bottom:32px; } }

    /* ====== Home ====== */
    .hero{ width:100%; text-align:center; margin:16px 0 24px; }
    .hero span{ font-size:42px; font-weight:800; color:var(--brand); letter-spacing:.5px; }
    .menu{display:flex; flex-direction:column; gap:18px; margin-top:10px; max-width:820px; margin-left:auto; margin-right:auto;}
    .btn{
      display:block; width:100%; text-align:center; cursor:pointer;
      background:var(--brand); color:#fff; border:0; border-radius:999px;
      padding:14px 18px; font-weight:800;
      box-shadow:0 4px 0 #5f1c11, var(--shadow);
      transition:transform .05s ease;
    }
    .btn small{ display:block; font-weight:700; font-size:15px; opacity:.95; margin-top:4px; }
    .btn:active{transform:translateY(1px)}

    /* ====== Views ====== */
    [data-view]{display:none}
    [data-view].active{display:block}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
      margin:18px auto;
    }
    .muted{color:var(--muted)}

    /* ====== Form ====== */
    form{display:grid; gap:12px}
    .field{display:grid; gap:6px; position:relative}
    .field label{ font-weight:800; font-size:18px; line-height:1.25; }
    .field small{color:var(--muted); font-size:13px}
    .field input,.field select,.field textarea{
      width:100%;
      border-radius:12px;
      border:1px solid #ddd;
      padding:10px 12px;
      font-size:15px;
      background:#fff;
      outline-color:var(--brand);
    }
    .field textarea{min-height:90px; resize:vertical}

    /* numbered bullets */
    .field[data-step]{ padding-left:52px; }
    .field[data-step]::before{
      content: attr(data-step);
      position:absolute;
      left:16px;
      top:50%;
      transform:translateY(-50%);
      width:28px;
      height:28px;
      display:grid;
      place-items:center;
      background:var(--brand);
      color:#fff;
      border-radius:50%;
      font-weight:900;
      font-size:13px;
      box-shadow:var(--shadow);
    }

    /* Report card sizing */
    [data-view="report"] .card{
      max-width: 860px;
      padding:18px;
    }
    [data-view="report"] h2{ font-size:22px; margin:0 0 10px; }

    /* Step header */
    .stepbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 10px;
      padding:10px 12px;
      background:#fff;
      border:1px solid #eee;
      border-radius:14px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .stepbar b{font-size:15px}
    .stepbar span{color:var(--muted); font-size:13px}

    .rowActions{
      display:flex;
      gap:10px;
      margin-top:6px;
    }
    .btnSecondary{
      width:100%;
      border-radius:999px;
      padding:12px 18px;
      font-weight:800;
      border:1px solid #e6e6e6;
      background:#fff;
      cursor:pointer;
      box-shadow: var(--shadow);
    }

    /* Status/Table */
    .kpi{
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;
      margin:8px 0 12px;
      max-width:1100px; margin-left:auto; margin-right:auto;
    }
    .kpi .box{
      background:#fff; border-radius:14px; box-shadow:var(--shadow);
      padding:14px; text-align:center
    }
    .kpi .box b{display:block; font-size:13px; color:var(--muted)}
    .kpi .box span{font-size:28px; font-weight:900; color:var(--brand)}
    table{width:100%; border-collapse:collapse; font-size:15px}
    th,td{padding:12px 10px; border-bottom:1px solid #eee; vertical-align:top}
    th{background:#fafafa; text-align:left; color:#444}

    /* Footer nav (mobile) */
    .tabbar{
      position:fixed; bottom:14px; left:0; right:0;
      display:flex; justify-content:center; pointer-events:none
    }
    .tabbar .inner{
      pointer-events:auto; background:#fff; border-radius:999px;
      box-shadow:var(--shadow); display:flex; gap:8px; padding:8px
    }
    .chip{
      border-radius:999px; padding:8px 12px; border:1px solid #eee;
      background:#fff; font-weight:700; cursor:pointer; font-size:14px
    }
    .chip small{ display:block; font-weight:500; font-size:11px; opacity:.85; }

    @media (min-width: 1024px){
      .tabbar{ display:none; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <button class="back" aria-label="ย้อนกลับ" onclick="go('home')">⟵</button>
    <h1 id="title">Maintenance</h1>
  </div>

  <main class="container">

    <!-- HOME -->
    <section data-view="home" class="active">
      <div class="hero"><span>Maintenance</span></div>

      <div class="menu">
        <button class="btn" onclick="go('report')">แจ้งซ่อม<small>Repair request</small></button>
        <button class="btn" onclick="go('status')">สถานะการแจ้งซ่อม<small>Request status</small></button>
        <button class="btn" onclick="go('powerbi')">Power BI<small>Dashboard</small></button>
        <button class="btn" onclick="go('guide')">คู่มือการใช้งาน<small>User guide</small></button>
      </div>
    </section>

    <!-- REPORT -->
    <section data-view="report">
      <div class="card">
        <h2>การแจ้งซ่อม (Repair Request)</h2>

        <div class="stepbar">
          <div>
            <b id="stepTitle">Step 1/2</b><br/>
            <span id="stepHint">กรอกข้อมูลหลัก (1–8)</span>
          </div>
          <div>
            <span class="muted" id="stepProgress">1–8 / 13</span>
          </div>
        </div>

        <form id="ticketForm">

          <!-- STEP 1 -->
          <div id="step1">
            <!-- 1 RequestDate (auto readonly) -->
            <div class="field" data-step="1">
              <label for="RequestDate">RequestDate</label>
              <input id="RequestDate" name="RequestDate" type="date" readonly />
              <small>ระบบใส่ให้อัตโนมัติ</small>
            </div>

            <!-- 2 TimeREquest (auto readonly) -->
            <div class="field" data-step="2">
              <label for="TimeREquest">TimeREquest</label>
              <input id="TimeREquest" name="TimeREquest" type="time" readonly />
              <small>ระบบใส่ให้อัตโนมัติ</small>
            </div>

            <!-- 3 Machine Section -->
            <div class="field" data-step="3">
              <label for="MachineSection">Machine Section</label>
              <select id="MachineSection" name="Machine Section" required>
                <option value="" disabled selected>เลือก... / Select...</option>
                <option>P3/1</option>
                <option>P3/2</option>
                <option>P3/3</option>
                <option>P4/1</option>
              </select>
            </div>

            <!-- 4 Machine -->
            <div class="field" data-step="4">
              <label for="Machine">Machine</label>
              <input id="Machine" name="Machine" type="text" placeholder="เช่น เครื่องตัด... / e.g. Cutting machine" required />
            </div>

            <!-- 5 Repairdescription -->
            <div class="field" data-step="5">
              <label for="Repairdescription">Repairdescription</label>
              <textarea id="Repairdescription" name="Repairdescription" placeholder="เล่าอาการ/ตำแหน่ง/เงื่อนไขที่พบ (Describe problem / location / condition)" required></textarea>
            </div>

            <!-- 6 Pre order -->
            <div class="field" data-step="6">
              <label for="PreOrder">Pre order</label>
              <input id="PreOrder" name="Pre order" type="text" placeholder="ถ้ามีให้กรอก (Optional)" />
              <small>ถ้ายังไม่มีให้เว้นว่างได้</small>
            </div>

            <!-- 7 Assigned -->
            <div class="field" data-step="7">
              <label for="Assigned">Assigned</label>
              <input id="Assigned" name="Assigned" type="text" placeholder="ชื่อช่าง/ผู้รับงาน (Optional)" />
            </div>

            <!-- 8 Department -->
            <div class="field" data-step="8">
              <label for="Department">Department</label>
              <select id="Department" name="Department" required>
                <option value="" disabled selected>เลือก... / Select...</option>
                <option>Mechanical</option>
                <option>Electrical</option>
                <option>Mold</option>
                <option>PM</option>
              </select>
            </div>

            <div class="rowActions">
              <button class="btn" type="button" onclick="nextStep()">ถัดไป <small>Next</small></button>
            </div>
          </div>

          <!-- STEP 2 -->
          <div id="step2" style="display:none;">
            <!-- 9 Supervisor -->
            <div class="field" data-step="9">
              <label for="Supervisor">Supervisor</label>
              <input id="Supervisor" name="Supervisor" type="text" placeholder="ชื่อหัวหน้าหรือผู้ตรวจ (Optional)" />
            </div>

            <!-- 10 Work Order No. -->
            <div class="field" data-step="10">
              <label for="WorkOrderNo">Work Order No.</label>
              <input id="WorkOrderNo" name="Work Order No." type="text" placeholder="เช่น WO-00123 (Optional)" />
            </div>

            <!-- 11 Time to repair -->
            <div class="field" data-step="11">
              <label for="TimeToRepair">Time to repair</label>
              <input id="TimeToRepair" name="Time to repair" type="text" placeholder="เช่น 2 ชั่วโมง / 120 นาที (Optional)" />
            </div>

            <!-- 12 ScgeduldedDate -->
            <div class="field" data-step="12">
              <label for="ScgeduldedDate">ScgeduldedDate</label>
              <input id="ScgeduldedDate" name="ScgeduldedDate" type="date" />
              <small>ถ้ายังไม่กำหนด ให้เว้นว่างได้</small>
            </div>

            <!-- 13 Status -->
            <div class="field" data-step="13">
              <label for="Status">Status</label>
              <select id="Status" name="Status" required>
                <option>Scheduled</option>
                <option>Completed</option>
                <option>Overdue</option>
              </select>
              <small>ค่าเริ่มต้นเป็น Scheduled</small>
            </div>

            <div class="rowActions">
              <button class="btnSecondary" type="button" onclick="prevStep()">ย้อนกลับ</button>
              <button class="btn" type="submit">ส่งคำขอซ่อม <small>Submit request</small></button>
            </div>
          </div>

        </form>

        <p class="muted" style="margin-top:10px">
          *หมายเหตุ:* ระบบจะสร้าง <code>RequestDate</code> และ <code>TimeREquest</code> ให้อัตโนมัติจากเวลาปัจจุบัน
        </p>
      </div>
    </section>

    <!-- SUCCESS -->
    <section data-view="success">
      <div class="card" style="text-align:center; max-width:820px;">
        <h2>การแจ้งซ่อมเสร็จสิ้น (Request Submitted)</h2>
        <p class="muted">ระบบได้บันทึกคำขอไว้แล้ว / Your request has been recorded.</p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap;">
          <button class="chip" onclick="go('status')">ดูสถานะ<br><small>View status</small></button>
          <button class="chip" onclick="go('home')">กลับหน้าแรก<br><small>Back to home</small></button>
        </div>
      </div>
    </section>

    <!-- STATUS -->
    <section data-view="status">
      <div class="kpi">
        <div class="box"><b>Scheduled</b><span id="kScheduled">0</span></div>
        <div class="box"><b>Completed</b><span id="kCompleted">0</span></div>
        <div class="box"><b>Overdue</b><span id="kOverdue">0</span></div>
      </div>

      <div class="card" style="max-width:1100px;">
        <h2 style="margin:0 0 10px; font-size:20px;">รายการคำขอ (Request List)</h2>
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:160px;">RequestDate</th>
              <th style="width:160px;">Machine Section</th>
              <th style="width:220px;">Machine</th>
              <th>Description</th>
              <th style="width:140px;">Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p class="muted" style="margin:10px 0 0">
          *กดสถานะในตารางเพื่อสลับ Scheduled → Completed → Overdue / Click status to toggle
        </p>
      </div>
    </section>

    <!-- POWER BI -->
    <section data-view="powerbi">
      <div class="card" style="max-width:1100px;">
        <h2 style="margin:0 0 12px">Power BI Dashboard</h2>
        <p class="muted">ใส่ลิงก์ Embed ของ Power BI แทน <code>src</code> ใน iframe</p>
        <div style="display:grid; gap:12px">
          <iframe title="Overview" style="width:100%; aspect-ratio:16/9; border:0; background:#fafafa"
            src="https://app.powerbi.com/view?r=eyJrIjoiYWM2MDViNTEtNGU4Mi00ODVlLTk4ZmItMzgzMTg1YzdjNDUxIiwidCI6ImY5MGM0NjQ3LTg4NmYtNGI0Yy1iMmViLTU1NWRmOWVjNGU4MSIsImMiOjEwfQ%3D%3D"
            allowfullscreen></iframe>
        </div>
      </div>
    </section>

    <!-- GUIDE -->
    <section data-view="guide">
      <div class="card" style="max-width:900px;">
        <h2 style="margin:0 0 12px">คู่มือการใช้งาน (User Guide)</h2>
        <ol style="font-size:16px; line-height:1.6;">
          <li>กด “แจ้งซ่อม” แล้วกรอกข้อมูลให้ครบ 2 หน้า จากนั้นกดส่ง</li>
          <li>ดูรายการและจำนวนงานใน “สถานะการแจ้งซ่อม”</li>
          <li>ฝังรายงานจริงใน “Power BI Dashboard” ด้วยลิงก์ Embed</li>
        </ol>
        <p class="muted">*ไฟล์นี้เป็น Single-File HTML — อัปโหลดขึ้น GitHub Pages แล้วใช้งานได้ทันที</p>
      </div>
    </section>

  </main>

  <!-- Mobile nav -->
  <div class="tabbar">
    <div class="inner">
      <button class="chip" onclick="go('home')">Home<br><small>หน้าแรก</small></button>
      <button class="chip" onclick="go('report')">แจ้งซ่อม<br><small>Repair</small></button>
      <button class="chip" onclick="go('status')">สถานะ<br><small>Status</small></button>
      <button class="chip" onclick="go('powerbi')">Power BI<br><small>Dashboard</small></button>
      <button class="chip" onclick="go('guide')">คู่มือ<br><small>Guide</small></button>
    </div>
  </div>

  <script>
    /* ===== Config ===== */
    const APP_NAME    = 'DATA';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbypCAC7GHGiZ9sN-3krJ4Eeq_0-0AdnnmwTGnRSKL_PIrfX70FagGunBQd5xDW5cevZ4A/exec';
    const API_TOKEN   = '65109010093';

    const titleMap = {
      home:"Maintenance",
      report:"การแจ้งซ่อม",
      success:"การแจ้งซ่อม",
      status:"สถานะการแจ้งซ่อม",
      powerbi:"Power BI",
      guide:"คู่มือการใช้งาน"
    };

    function show(view){
      document.querySelectorAll('[data-view]').forEach(el=>el.classList.remove('active'));
      const el = document.querySelector(`[data-view="${view}"]`);
      if (el) el.classList.add('active');

      document.getElementById('title').textContent = titleMap[view] || 'Maintenance';
      document.title = `${titleMap[view] || 'Maintenance'} · ${APP_NAME}`;
      history.replaceState(null, '', `#${view}`);
      window.scrollTo({top:0, behavior:'smooth'});

      if(view === 'status') renderTable();
      if(view === 'report') syncAutoDateTime();
    }
    function go(view){ show(view); }
    window.addEventListener('load', () => {
      const initial = (location.hash || '#home').slice(1);
      show(initial);
    });

    /* ===== Stepper (2 pages) ===== */
    function setStep(step){
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const title = document.getElementById('stepTitle');
      const hint  = document.getElementById('stepHint');
      const prog  = document.getElementById('stepProgress');

      if(step === 1){
        step1.style.display = '';
        step2.style.display = 'none';
        title.textContent = 'Step 1/2';
        hint.textContent = 'กรอกข้อมูลหลัก (1–8)';
        prog.textContent = '1–8 / 13';
      }else{
        step1.style.display = 'none';
        step2.style.display = '';
        title.textContent = 'Step 2/2';
        hint.textContent = 'ข้อมูลเพิ่มเติม (9–13)';
        prog.textContent = '9–13 / 13';
      }
    }

    function nextStep(){
      // เช็ค required ของ step1 ก่อน
      const requiredIds = ['MachineSection','Machine','Repairdescription','Department'];
      for(const id of requiredIds){
        const el = document.getElementById(id);
        if(!el) continue;
        if(String(el.value||'').trim()===''){
          el.focus();
          alert('กรุณากรอกข้อมูลที่จำเป็นให้ครบก่อน');
          return;
        }
      }
      setStep(2);
    }
    function prevStep(){ setStep(1); }

    /* ===== Local fallback (demo) ===== */
    const DEMO = !/^https?:\/\//i.test(WEB_APP_URL);
    const KEY='tickets.v3';
    const getTickets=()=>JSON.parse(localStorage.getItem(KEY)||'[]');
    const setTickets=(v)=>localStorage.setItem(KEY,JSON.stringify(v));

    async function fetchJSON(url, options){
      const res = await fetch(url, options);
      const text = await res.text();
      try{ return JSON.parse(text); }
      catch(e){ throw new Error(`Bad response (${res.status}): ${text.slice(0,200)}`); }
    }
    async function apiCreateTicket(payload){
      const body = new URLSearchParams({ action:'create', token: API_TOKEN, ...payload }).toString();
      return fetchJSON(WEB_APP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body
      });
    }
    async function apiListTickets(limit=500){
      return fetchJSON(`${WEB_APP_URL}?action=list&limit=${limit}`);
    }
    async function apiUpdateStatus(id, status){
      const body = new URLSearchParams({ action:'updateStatus', id, status, token: API_TOKEN }).toString();
      return fetchJSON(WEB_APP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body
      });
    }

    /* ===== Auto RequestDate + TimeREquest ===== */
    function syncAutoDateTime(){
      const now = new Date();
      const d = now.toLocaleDateString('en-CA'); // YYYY-MM-DD
      const t = now.toTimeString().slice(0,5);   // HH:MM
      const dateEl = document.getElementById('RequestDate');
      const timeEl = document.getElementById('TimeREquest');
      if(dateEl) dateEl.value = d;
      if(timeEl) timeEl.value = t;
      setStep(1);
    }

    /* ===== Submit form ===== */
    document.getElementById('ticketForm').addEventListener('submit', async (e)=>{
      e.preventDefault();

      // ensure auto datetime updated
      syncAutoDateTime();

      const data = Object.fromEntries(new FormData(e.target).entries());

      // payload 13 fields (exact keys)
      const payload = {
        "RequestDate": data["RequestDate"] || '',
        "TimeREquest": data["TimeREquest"] || '',
        "Machine Section": data["Machine Section"] || '',
        "Machine": data["Machine"] || '',
        "Repairdescription": data["Repairdescription"] || '',
        "Pre order": data["Pre order"] || '',
        "Assigned": data["Assigned"] || '',
        "Department": data["Department"] || '',
        "Supervisor": data["Supervisor"] || '',
        "Work Order No.": data["Work Order No."] || '',
        "Time to repair": data["Time to repair"] || '',
        "ScgeduldedDate": data["ScgeduldedDate"] || '',
        "Status": data["Status"] || 'Scheduled'
      };

      try{
        if(DEMO){
          const ticket = {
            id: Date.now().toString(36),
            date: payload.RequestDate,
            dept: payload["Machine Section"],
            machine: payload.Machine,
            desc: payload.Repairdescription,
            status: payload.Status
          };
          const all = getTickets();
          all.unshift(ticket);
          setTickets(all);
          e.target.reset();
          go('success');
        } else {
          const r = await apiCreateTicket(payload);
          if(r.ok){
            e.target.reset();
            go('success');
          } else {
            alert('บันทึกไม่สำเร็จ: ' + (r.error || 'unknown'));
          }
        }
      } catch(err){
        alert('เครือข่ายผิดพลาด: ' + err.message);
      }
    });

    /* ===== Render table ===== */
    async function renderTable(){
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = DEMO ? '' : '<tr><td colspan="5">Loading...</td></tr>';

      let rows = [];
      if(DEMO){
        rows = getTickets();
      } else {
        try{
          const r = await apiListTickets(500);
          rows = (r.rows||[]).map(x=>({
            id: x['ID'] || x['id'] || '',
            date: x['RequestDate'] || x['Request Date'] || '',
            dept: x['Machine Section'] || x['Machine Department'] || '',
            machine: x['Machine'] || x['Machine Name'] || '',
            desc: x['Repairdescription'] || x['Problem Description'] || '',
            status: x['Status'] || 'Scheduled'
          }));
        } catch(e){
          tbody.innerHTML = '<tr><td colspan="5">Load failed</td></tr>';
          return;
        }
      }

      let s=0,c=0,o=0;
      tbody.innerHTML='';
      for(const r of rows){
        if(r.status==='Scheduled') s++;
        else if(r.status==='Completed') c++;
        else o++;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.date||'')}</td>
          <td>${escapeHtml(r.dept||'')}</td>
          <td>${escapeHtml(r.machine||'')}</td>
          <td>${escapeHtml(r.desc||'')}</td>
          <td><button class="chip" data-id="${escapeHtml(r.id||'')}" data-status="${escapeHtml(r.status)}">${escapeHtml(r.status)}</button></td>
        `;
        tbody.appendChild(tr);
      }
      document.getElementById('kScheduled').textContent=s;
      document.getElementById('kCompleted').textContent=c;
      document.getElementById('kOverdue').textContent=o;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    /* ===== Toggle status ===== */
    document.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button.chip[data-id]');
      if(!btn) return;

      const cycle = { 'Scheduled':'Completed', 'Completed':'Overdue', 'Overdue':'Scheduled' };
      const id = btn.getAttribute('data-id');
      const next = cycle[btn.dataset.status] || 'Scheduled';

      if(DEMO){
        const all = getTickets();
        const t = all.find(x=>x.id===id);
        if(t){
          t.status = next;
          setTickets(all);
          renderTable();
        }
      } else {
        try{
          const r = await apiUpdateStatus(id, next);
          if(r.ok) renderTable();
          else alert('อัปเดตไม่สำเร็จ');
        } catch(err){
          alert('เครือข่ายผิดพลาด: ' + err.message);
        }
      }
    });
  </script>
</body>
</html>
