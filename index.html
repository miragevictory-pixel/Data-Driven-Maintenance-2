<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maintenance Portal</title>
  <meta name="application-name" content="Maintenance Portal">
  <meta name="apple-mobile-web-app-title" content="Maintenance Portal">

  <style>
    /* Styles remain unchanged... */
  </style>
</head>

<body>
  <div class="topbar">
    <button class="back" aria-label="ย้อนกลับ" onclick="go('home')">⟵</button>
    <h1 id="title">Maintenance</h1>
  </div>

  <main class="container">
    <!-- Sections (home, report, etc.) remain unchanged... -->
  </main>

  <script>
    /* ===== Config ===== */
    const APP_NAME    = 'Centralized Database from factory';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxU9dSw9b8YH48jV2U8apxzxj4o7ikoMrdOPzQhhwqfHEmAkI1HyIl1hJTJU76TTtxGxA/exec';
    const API_TOKEN   = '0992183266';

    /* ===== Router ===== */
    const titleMap = {
      home: "Maintenance",
      report: "การแจ้งซ่อม",
      success: "การแจ้งซ่อม",
      status: "สถานะการแจ้งซ่อม",
      update: "Update งานซ่อม",
      powerbi: "Power BI",
      guide: "คู่มือการใช้งาน"
    };

    // Function to switch between views
    function show(view) {
      console.log('View being switched to:', view);  // Debugging line
      document.querySelectorAll('[data-view]').forEach(el => el.classList.remove('active'));
      const el = document.querySelector(`[data-view="${view}"]`);
      if (el) {
        el.classList.add('active');
        console.log(`${view} view is now active`); // Debugging line
      }

      document.getElementById('title').textContent = titleMap[view] || 'Maintenance';
      document.title = `${titleMap[view] || 'Maintenance'} · ${APP_NAME}`;
      history.replaceState(null, '', `#${view}`);
      window.scrollTo({ top: 0, behavior: 'smooth' });

      if (view === 'status') renderTable();
      if (view === 'report') setAutoDateTime();
    }

    // Helper function to navigate between views
    function go(view) {
      console.log('Navigating to:', view); // Debugging line
      show(view);
    }

    window.addEventListener('load', () => {
      const initial = (location.hash || '#home').slice(1);
      show(initial);
      setAutoDateTime();
    });

    function setAutoDateTime() {
      const now = new Date();
      const RequestDate = now.toLocaleDateString('en-CA'); // YYYY-MM-DD
      const TimeRequest = now.toTimeString().slice(0, 5);   // HH:MM
      const d = document.getElementById('RequestDateShow');
      const t = document.getElementById('TimeRequestShow');
      if (d) d.value = RequestDate;
      if (t) t.value = TimeRequest;
    }

    /* ===== Local fallback (demo) ===== */
    const DEMO = !/^https?:\/\//i.test(WEB_APP_URL);
    const KEY = 'tickets.v3';
    const getTickets = () => JSON.parse(localStorage.getItem(KEY) || '[]');
    const setTickets = (v) => localStorage.setItem(KEY, JSON.stringify(v));

    /* ===== API helpers ===== */
    async function fetchJSON(url, options) {
      const res = await fetch(url, options);
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        throw new Error(`Bad response (${res.status}): ${text.slice(0, 200)}`);
      }
    }

    async function apiCreateTicket(payload) {
      const body = new URLSearchParams({ action: 'create', token: API_TOKEN, ...payload }).toString();
      return fetchJSON(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
    }

    async function apiListTickets(limit = 500) {
      return fetchJSON(`${WEB_APP_URL}?action=list&limit=${limit}`);
    }

    // ⚠️ ต้องให้ Apps Script รองรับ action นี้
    async function apiUpdateJob(payload) {
      const body = new URLSearchParams({ action: 'updateJob', token: API_TOKEN, ...payload }).toString();
      return fetchJSON(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
    }

    /* ===== Submit (Create) ===== */
    document.getElementById('ticketForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());

      // auto date/time
      const now = new Date();
      const RequestDate = now.toLocaleDateString('en-CA');
      const TimeRequest = now.toTimeString().slice(0, 5);

      // payload ตามหน้าแจ้งซ่อม (กรอกน้อย)
      const payload = {
        RequestDate,
        TimeRequest,
        "Machine Section": data.dept || '',
        Machine: data.machine || '',
        Repairdescription: data.desc || '',
        "Pre order": data.preorder || '',
        Assigned: data.assignedTo || '',
        Status: 'Scheduled'
        // WorkOrderNo ให้ Apps Script ออกเลขให้
      };

      try {
        if (DEMO) {
          const ticket = {
            id: Date.now().toString(36),
            workOrderNo: `DEMO-${Date.now()}`,
            RequestDate,
            TimeRequest,
            dept: payload["Machine Section"],
            machine: payload.Machine,
            desc: payload.Repairdescription,
            status: payload.Status
          };
          const all = getTickets();
          all.unshift(ticket);
          setTickets(all);
          e.target.reset();
          setAutoDateTime();
          go('success');
        } else {
          const r = await apiCreateTicket(payload);
          if (r.ok) {
            e.target.reset();
            setAutoDateTime();
            go('success');
          } else {
            alert('บันทึกไม่สำเร็จ: ' + (r.error || 'unknown'));
          }
        }
      } catch (err) {
        alert('เครือข่ายผิดพลาด: ' + err.message);
      }
    });

    /* ===== Open update view (Scheduled only) ===== */
    function openUpdate(ticket) {
      // เติมหัวบนหน้า update
      document.getElementById('uId').value = ticket.id || '';
      document.getElementById('uWoHidden').value = ticket.workOrderNo || '';
      document.getElementById('uWorkOrder').textContent = ticket.workOrderNo || '-';
      document.getElementById('uMachine').textContent = ticket.machine || '-';

      // reset ฟอร์ม
      document.getElementById('uSupervisor').value = '';
      document.getElementById('uTimeToRepair').value = '';
      document.getElementById('uDepartment').value = '';

      go('update');
    }

    /* ===== Submit update (Complete) ===== */
    document.getElementById('updateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());

      const payload = {
        id: data.id || '',
        "Work Order No.": data.workOrderNo || '',
        Supervisor: data.supervisor || '',
        Department: data.department || '',
        "Time to repair": data.timeToRepair || '',
        Status: 'Completed'
      };

      try {
        if (DEMO) {
          const all = getTickets();
          const t = all.find(x => x.id === payload.id);
          if (t) {
            t.supervisor = payload.Supervisor;
            t.department = payload.Department;
            t.timeToRepair = payload["Time to repair"];
            t.status = 'Completed';
            setTickets(all);
          }
          go('status');
        } else {
          const r = await apiUpdateJob(payload);
          if (r.ok) {
            go('status');
          } else {
            alert('อัปเดตไม่สำเร็จ: ' + (r.error || 'unknown'));
          }
        }
      } catch (err) {
        alert('เครือข่ายผิดพลาด: ' + err.message);
      }
    });

    /* ===== Render table ===== */
    async function renderTable() {
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = DEMO ? '' : '<tr><td colspan="8">Loading...</td></tr>';

      let rows = [];
      if (DEMO) {
        rows = getTickets().map(x => ({
          id: x.id,
          workOrderNo: x.workOrderNo,
          RequestDate: x.RequestDate,
          TimeRequest: x.TimeRequest,
          dept: x.dept,
          machine: x.machine,
          desc: x.desc,
          status: x.status || 'Scheduled'
        }));
      } else {
        try {
          const r = await apiListTickets(500);

          // รองรับ header ได้หลายชื่อ เผื่อคุณตั้งคอลัมน์ไม่เหมือนกัน
          rows = (r.rows || []).map(x => ({
            id: x['ID'] || x['id'] || '',
            workOrderNo: x['WorkOrderNo'] || x['Work Order No.'] || x['Work Order No'] || '',
            RequestDate: x['RequestDate'] || x['Request Date'] || x['Date request'] || '',
            TimeRequest: x['TimeRequest'] || x['Request Time'] || x['Time request'] || '',
            dept: x['Machine Section'] || x['Machine Department'] || '',
            machine: x['Machine'] || x['Machine Name'] || '',
            desc: x['Repairdescription'] || x['Problem Description'] || '',
            status: x['Status'] || 'Scheduled'
          }));
        } catch (e) {
          tbody.innerHTML = '<tr><td colspan="8">Load failed</td></tr>';
          return;
        }
      }

      let s = 0, c = 0, o = 0;
      tbody.innerHTML = '';

      for (const r of rows) {
        if (r.status === 'Scheduled') s++;
        else if (r.status === 'Completed') c++;
        else o++;

        const statusPill = renderStatusPill(r.status);

        const canUpdate = (r.status === 'Scheduled');
        const actionBtn = canUpdate
          ? `<button class="chip primary" data-action="openUpdate" data-id="${escapeHtml(r.id)}">Update</button>`
          : `<span class="muted">—</span>`;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.workOrderNo || '')}</td>
          <td>${escapeHtml(formatDateCell(r.RequestDate || ''))}</td>
          <td>${escapeHtml(formatTimeCell(r.TimeRequest || ''))}</td>
          <td>${escapeHtml(r.dept || '')}</td>

          <td style="font-size:17px; font-weight:700; line-height:1.35;">
            ${escapeHtml(r.machine || '')}
          </td>

          <td style="font-size:17px; font-weight:700; line-height:1.35;">
            ${escapeHtml(r.desc || '')}
          </td>

          <td>${statusPill}</td>
          <td>${actionBtn}</td>
        `;
        tbody.appendChild(tr);

      }

      document.getElementById('kScheduled').textContent = s;
      document.getElementById('kCompleted').textContent = c;
      document.getElementById('kOverdue').textContent = o;

      // เก็บ rows ล่าสุดไว้ให้ปุ่ม Update เรียกใช้
      window.__LAST_ROWS__ = rows;
    }

    function renderStatusPill(status) {
      const st = String(status || '').trim();
      if (st === 'Completed') {
        return `<span class="pill completed"><span class="dot"></span>Completed</span>`;
      }
      if (st === 'Overdue') {
        return `<span class="pill overdue"><span class="dot"></span>Overdue</span>`;
      }
      return `<span class="pill"><span class="dot"></span>Scheduled</span>`;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", "&#039;");
    }

    /* ===== Click handlers ===== */
    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button[data-action="openUpdate"]');
      if (!btn) return;

      const id = btn.getAttribute('data-id');
      const rows = window.__LAST_ROWS__ || [];
      const t = rows.find(x => String(x.id) === String(id));
      if (t) openUpdate(t);
    });
  </script>
</body>
</html>
