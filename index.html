<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maintenance Portal</title>

  <style>
    :root{
      --brand:#9e2f1c;
      --bg:#fff9f7;
      --text:#1e1e1e;
      --muted:#6b6b6b;
      --card:#ffffff;
      --radius:18px;
      --shadow:0 6px 18px rgba(0,0,0,.12);
    }
#technician-list {
  padding: 20px;
  border: 1px solid #ddd;
  background-color: #f9f9f9;
  margin-top: 20px;
}

.technician {
  background: #fff;
  padding: 15px;
  margin: 10px 0;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.technician h3 {
  color: var(--brand);
  font-size: 20px;
  margin-bottom: 10px;
}

.technician p {
  margin: 5px 0;
}
    * , *::before, *::after{ box-sizing:border-box; }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "TH Sarabun New", Tahoma, sans-serif;
      color:var(--text);
      background:var(--bg);
      font-size:16px;
      line-height:1.5;
    }
    
    .topbar{
      position:sticky; top:0; z-index:20;
      background:var(--brand); color:#fff;
      padding:14px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    .topbar .left{
      display:flex; align-items:center; gap:12px;
    }
    .topbar h1{ font-size:20px; margin:0; font-weight:800; letter-spacing:.3px }
    .topbar .right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .back{
      appearance:none; border:0; cursor:pointer;
      width:40px; height:40px; border-radius:999px;
      display:grid; place-items:center;
      color:#fff;
      background: rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.18), 0 6px 14px rgba(0,0,0,.18);
      font-size:20px; line-height:1;
    }

    .container{ max-width: 1100px; margin:0 auto; padding: 22px 18px 40px; }

    [data-view]{display:none}
    [data-view].active{display:block}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      margin:18px 0;
    }
    .muted{color:var(--muted)}

    .hero{ width:100%; text-align:center; margin: 18px 0 18px; }
    .hero span{ font-size:40px; font-weight:900; color:var(--brand); letter-spacing:0.6px; }

    .menu{
      display:flex; flex-direction:column;
      gap:14px; margin-top:14px;
      max-width: 780px; margin-left:auto; margin-right:auto;
    }

    .btn{
      width:100%;
      text-align:center;
      cursor:pointer;
      background:var(--brand);
      color:#fff;
      border:0;
      border-radius:999px;
      padding: 14px 22px;
      font-weight:900;
      box-shadow:0 4px 0 #5f1c11, var(--shadow);
    }
    .btn small{ display:block; font-weight:700; font-size:15px; opacity:.92; margin-top:2px; }
    .btn:active{ transform: translateY(1px); box-shadow:0 3px 0 #5f1c11, var(--shadow); }

    form{display:grid; gap:14px}
    .field{display:grid; gap:8px; position:relative}
    .field label{ font-weight:800; font-size:18px; line-height:1.35; }
    .field small{color:var(--muted); font-size:13px;}
    .field input,.field select,.field textarea{
      width:100%;
      border-radius:12px;
      border:1px solid #ddd;
      padding:12px 12px;
      font-size:16px;
      background:#fff;
      outline-color:var(--brand);
    }
    .field textarea{min-height:96px; resize:vertical}

    .field[data-step]{ padding-left: 56px; }
    .field[data-step]::before{
      content: attr(data-step);
      position:absolute;
      left:16px;
      top:50%;
      transform:translateY(-50%);
      width:28px; height:28px;
      display:grid; place-items:center;
      background:var(--brand); color:#fff;
      border-radius:50%;
      font-weight:900; font-size:13px;
      box-shadow:var(--shadow);
    }

    .row-actions{
      display:flex; gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top: 6px;
      align-items:center;
    }

    .chip{
      border-radius:999px;
      padding:10px 14px;
      border:1px solid #eee;
      background:#fff;
      font-weight:800;
      cursor:pointer;
      font-size:14px;
      box-shadow: 0 4px 12px rgba(0,0,0,.06);
    }
    .chip.primary{ border:0; background: rgba(158,47,28,.10); color: var(--brand); }
    .chip:active{ transform: translateY(1px); }

    .kpi{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      margin: 10px 0 14px;
    }
    .kpi .box{
      background:#fff;
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px 14px;
      text-align:center;
    }
    .kpi .box b{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    .kpi .box span{ font-size:28px; font-weight:900; color:var(--brand); line-height:1; }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:16px;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid #eee;
      vertical-align:top;
    }
    th{
      background:#fafafa;
      text-align:left;
      color:#444;
      font-weight:800;
      font-size:14px;
      white-space:nowrap;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:#fff; border:1px solid #eee; font-weight:800;
      box-shadow: 0 4px 12px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .dot{ width:10px; height:10px; border-radius:999px; background: var(--brand); }
    .pill.completed .dot{ background: #1f8a3b; }

    .grid-2{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:860px){ .grid-2{ grid-template-columns:1fr 1fr; } }

    .tech-head{
      display:flex; justify-content:space-between; align-items:flex-end;
      gap:12px; flex-wrap:wrap; margin-bottom:14px;
    }
    .tech-title{ margin:0; font-size:24px; font-weight:900; color:var(--brand); }
    .tech-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .tech-search{
      width:min(260px, 70vw); border-radius:999px; border:1px solid #e6e6e6;
      padding:10px 14px; font-weight:700; outline-color:var(--brand); background:#fff;
    }
    .tech-select{
      border-radius:999px; border:1px solid #e6e6e6;
      padding:10px 14px; font-weight:800; background:#fff; outline-color:var(--brand);
    }

    .tech-kpi{
      display:grid; grid-template-columns:repeat(3, 1fr);
      gap:12px; margin: 10px 0 14px;
    }
    @media (max-width:720px){ .tech-kpi{ grid-template-columns:1fr; } }

    .tech-split{
      display:grid; grid-template-columns: 360px 1fr;
      gap:12px;
    }
    @media (max-width:980px){ .tech-split{ grid-template-columns:1fr; } }

    .tech-panel{
      background:#fff; border:1px solid #f0f0f0;
      border-radius:16px; box-shadow: 0 8px 22px rgba(0,0,0,.06);
      padding:14px;
    }
    .panel-title{ margin:0 0 10px; font-size:16px; font-weight:900; color:#333; }

    .tech-grid{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;
    }
    @media (max-width:980px){ .tech-grid{ grid-template-columns:repeat(2, 1fr); } }
    @media (max-width:640px){ .tech-grid{ grid-template-columns:1fr; } }

    .tech-card{
      background:#fff; border:1px solid #f0f0f0;
      border-radius:16px; box-shadow: 0 8px 22px rgba(0,0,0,.08);
      padding:14px; cursor:pointer;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .tech-card:hover{ transform: translateY(-1px); box-shadow: 0 10px 26px rgba(0,0,0,.10); }

    .tech-name{ margin:0 0 10px; font-size:18px; font-weight:900; color:var(--brand); }
    .badges{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px; border-radius:999px;
      font-weight:900; font-size:13px;
      border:1px solid #eee; background:#fafafa;
    }
    .badge .mini-dot{ width:8px; height:8px; border-radius:999px; background:var(--brand); }
    .badge.scheduled{ background: rgba(158,47,28,.10); border-color: rgba(158,47,28,.18); color: var(--brand); }
    .badge.completed{ background: rgba(31,138,59,.10); border-color: rgba(31,138,59,.18); color:#1f8a3b; }
    .badge.completed .mini-dot{ background:#1f8a3b; }

    .tech-meta{ display:flex; justify-content:space-between; gap:10px; color:#555; font-weight:800; font-size:14px; }
    .progress{ margin-top:10px; height:10px; background:#f2f2f2; border-radius:999px; overflow:hidden; }
    .progress > div{ height:100%; background: var(--brand); width:0%; }

    .top5-item{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 10px; border-radius:12px;
      border:1px solid #f1f1f1; background:#fff;
      margin:8px 0;
    }
    .top5-item b{ color:var(--brand); }
    .top5-item .count{ font-weight:900; }

    .modal{ position:fixed; inset:0; display:none; z-index:1000; }
    .modal.show{ display:block; }
    .modal-backdrop{ position:absolute; inset:0; background: rgba(0,0,0,.35); }
    .modal-card{
      position:relative;
      max-width: 900px; margin: 6vh auto; background:#fff;
      border-radius:18px; box-shadow: 0 18px 50px rgba(0,0,0,.25);
      padding:16px; width: calc(100% - 24px);
    }
    .modal-head{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    .modal-title{ font-size:20px; font-weight:900; color:var(--brand); }
    .modal-tabs{ display:flex; gap:10px; margin:12px 0; flex-wrap:wrap; }
    .modal-list{ display:grid; gap:10px; max-height: 60vh; overflow:auto; padding-right:4px; }
    .job-card{
      border:1px solid #f0f0f0; border-radius:14px;
      padding:12px; background:#fff;
      display:grid; gap:8px;
    }
    .job-row{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .job-row b{ color:#333; }
    .job-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="left">
      <button class="back" aria-label="ย้อนกลับ" onclick="go('home')">⟵</button>
      <h1 id="title">Maintenance</h1>
    </div>
    <div class="right"></div>
  </div>

  <main class="container">

    <!-- HOME -->
    <section data-view="home" class="active">
      <div class="hero"><span>Maintenance</span></div>
      <div class="menu">
        <button class="btn" onclick="go('report')">แจ้งซ่อม <small>Repair request</small></button>
        <button class="btn" onclick="go('status')">สถานะการแจ้งซ่อม <small>Request status</small></button>
        <button class="btn" onclick="go('powerbi')">Power BI <small>Dashboard</small></button>
        <button class="btn" onclick="go('guide')">คู่มือการใช้งาน <small>User guide</small></button>
        <button class="btn" onclick="go('technician')">เจ้าหน้าที่ซ่อมบำรุง <small>Technician</small></button>
      </div>
    </section>

    <!-- REPORT -->
    <section data-view="report">
      <div class="card">
        <h2 style="margin:0 0 10px">การแจ้งซ่อม (Repair Request)</h2>

        <div class="grid-2" style="margin: 10px 0 14px;">
          <div class="field">
            <label for="RequestDateShow">Date request (Auto)</label>
            <input id="RequestDateShow" name="RequestDateShow" type="text" disabled />
            <small>ระบบจะสร้างให้อัตโนมัติ</small>
          </div>
          <div class="field">
            <label for="TimeRequestShow">Time request (Auto)</label>
            <input id="TimeRequestShow" name="TimeRequestShow" type="text" disabled />
            <small>ระบบจะสร้างให้อัตโนมัติ</small>
          </div>
        </div>

        <form id="ticketForm">
          <div class="field" data-step="1">
            <label for="deptInput">Machine section</label>
            <input id="deptInput" name="dept" list="deptList" placeholder="พิมพ์เพื่อค้นหา เช่น P3/1" required />
            <datalist id="deptList"></datalist>
            <small>พิมพ์ค้นหาได้ / เลือกจากรายการ (ดึงจาก Google Sheet)</small>
          </div>

          <div class="field" data-step="2">
            <label for="machineInput">Machine</label>
            <input id="machineInput" name="machine" list="machineList" placeholder="เลือกเครื่องตาม section" required />
            <datalist id="machineList"></datalist>
            <small>รายการจะเปลี่ยนตาม Machine section</small>
          </div>

          <div class="field" data-step="3">
            <label for="desc">Repairdescription</label>
            <textarea id="desc" name="desc" placeholder="เล่าอาการ/ตำแหน่ง/เงื่อนไขที่พบ" required></textarea>
          </div>

          <div class="field" data-step="5">
            <label for="assignedTo">Assigned</label>
            <input id="assignedTo" name="assignedTo" type="text" placeholder="ชื่อช่าง/ผู้รับงาน (Optional)" />
            <small>ถ้ายังไม่ระบุ ให้เว้นว่างได้</small>
          </div>

          <div class="row-actions">
            <span class="pill" title="Status จะถูกตั้งค่าอัตโนมัติ">
              <span class="dot"></span> Status: Scheduled (Auto)
            </span>
            <button class="btn" type="submit">ส่งคำขอซ่อม <small>Submit request</small></button>
          </div>
        </form>
      </div>
    </section>

    <!-- SUCCESS -->
    <section data-view="success">
      <div class="card" style="text-align:center">
        <h2>บันทึกสำเร็จ</h2>
        <p class="muted">ระบบได้บันทึกคำขอไว้แล้ว</p>
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
          <button class="chip primary" onclick="go('status')">ดูสถานะ</button>
          <button class="chip" onclick="go('home')">กลับหน้าแรก</button>
        </div>
      </div>
    </section>

    <!-- STATUS -->
    <section data-view="status">
      <div class="kpi">
        <div class="box"><b>Scheduled</b><span id="kScheduled">0</span></div>
        <div class="box"><b>Completed</b><span id="kCompleted">0</span></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0; font-size:20px">รายการคำขอ (Request List)</h3>
        <table id="tbl">
          <thead>
            <tr>
              <th>Work Order</th>
              <th>RequestDate</th>
              <th>Time</th>
              <th>Machine Section</th>
              <th>Machine</th>
              <th>Description</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <p class="muted" style="margin:12px 0 0">
          *กด “Update” เฉพาะรายการที่เป็น Scheduled เพื่อกรอก Supervisor/Time to repair/Department แล้วปิดงานเป็น Completed*
        </p>
      </div>
    </section>

    <!-- UPDATE -->
    <section data-view="update">
      <div class="card">
        <h2 style="margin:0 0 10px">Update สถานะการซ่อม (Job Update)</h2>

        <div class="grid-2" style="margin: 8px 0 12px;">
          <div class="pill" style="justify-content:space-between;">
            <span style="display:flex; align-items:center; gap:8px;">
              <span class="dot"></span><span>Work Order No.</span>
            </span>
            <span id="uWorkOrder" style="font-weight:900; color:var(--brand);">-</span>
          </div>
          
          <div class="pill" style="justify-content:space-between;">
            <span style="display:flex; align-items:center; gap:8px;">
              <span class="dot"></span><span>Machine</span>
            </span>
            <span id="uMachine" style="font-weight:900;">-</span>
          </div>
          
           <div class="pill" style="justify-content:space-between;">
            <span style="display:flex; align-items:center; gap:8px;">
              <span class="dot"></span><span>Update Date-Time (Auto)</span>
            </span>
            <span id="uCompletedPreview" style="font-weight:900;">-</span>
          </div>
         </div>
      
        <p class="muted" style="margin: 0 0 12px;">
          กรอก 3 ช่องนี้ แล้วกดบันทึก ระบบจะเปลี่ยนสถานะเป็น <b>Completed</b> และอัปเดตในชีต “บรรทัดเดิม”
        </p>

        <form id="updateForm">
          <input type="hidden" id="uId" name="id" />
          <input type="hidden" id="uWoHidden" name="workOrderNo" />

          <div class="field" data-step="1">
            <label for="uSupervisor">Supervisor</label>
            <input id="uSupervisor" name="supervisor" type="text" required />
          </div>

          <div class="field" data-step="2">
            <label for="uTimeToRepair">Time to repair</label>
            <input id="uTimeToRepair" name="timeToRepair" type="text" placeholder="เช่น 2.5 hrs / 150 min" required />
          </div>

          <div class="field" data-step="3">
            <label for="uDepartment">Department</label>
            <select id="uDepartment" name="department" required>
              <option value="" disabled selected>เลือก...</option>
              <option>Mechanical</option>
              <option>Electrical</option>
              <option>Mold</option>
              <option>PM</option>
            </select>
          </div>

          <div class="row-actions">
            <button type="button" class="chip" onclick="go('status')">⟵ กลับ</button>
            <button class="btn" type="submit">บันทึกและปิดงาน <small>Save & Complete</small></button>
          </div>
        </form>

        <p class="muted" style="margin-top:12px">
          *หมายเหตุ:* ปุ่ม Save จะทำงานได้เมื่อฝั่ง Apps Script มี action <code>updateJob</code>
        </p>
      </div>
    </section>

    <!-- POWER BI -->
    <section data-view="powerbi">
      <div class="card">
        <h2 style="margin:0 0 12px">Power BI Dashboard</h2>
        <p class="muted">Replace src ด้วยลิงก์ Embed ของคุณ</p>
        <iframe
          title="Overview"
          style="width:100%; aspect-ratio:16/9; border:0; background:#fafafa; border-radius:14px;"
          src="https://app.powerbi.com/view?r=eyJrIjoiYWM2MDViNTEtNGU4Mi00ODVlLTk4ZmItMzgzMTg1YzdjNDUxIiwidCI6ImY5MGM0NjQ3LTg4NmYtNGI0Yy1iMmViLTU1NWRmOWVjNGU4MSIsImMiOjEwfQ%3D%3D"
          allowfullscreen></iframe>
      </div>
    </section>

    <!-- GUIDE -->
    <section data-view="guide">
      <div class="card">
        <h2 style="margin:0 0 10px">คู่มือการใช้งาน</h2>
        <ol>
          <li>กด “แจ้งซ่อม” กรอกข้อมูล แล้วกด Submit</li>
          <li>ไปที่ “สถานะการแจ้งซ่อม” เพื่อดูรายการ</li>
          <li>รายการที่เป็น Scheduled กด Update</li>
          <li>กรอก Supervisor / Time to repair / Department แล้วกด Save</li>
        </ol>
        <p class="muted">ถ้าจะใช้งานจริงกับชีต: ต้องมี Apps Script actions เช่น <code>create</code>, <code>list</code>, <code>updateJob</code>, <code>machinemaster</code></p>
      </div>
    </section>
    
    <!-- Technician -->
    <section data-view="technician">
  <div class="card">
    <div class="tech-head">
      <div>
        <h2 class="tech-title">Technician</h2>
        <p class="muted" style="margin:6px 0 0">สรุปงานแยกตามช่าง + เปิดดูรายละเอียดงานได้</p>
      </div>

      <div class="tech-actions">
        <input id="techSearch" class="tech-search" type="text" placeholder="ค้นหาชื่อช่าง..." />
        <select id="techSectionFilter" class="tech-select">
          <option value="">ทุก Machine Section</option>
        </select>
        <button class="chip primary" onclick="fetchTechnicianRequests(true)">Refresh</button>
      </div>
    </div>

    <div class="tech-kpi">
      <div class="box"><b>Technicians</b><span id="kTech">0</span></div>
      <div class="box"><b>Scheduled</b><span id="kTechScheduled">0</span></div>
      <div class="box"><b>Completed</b><span id="kTechCompleted">0</span></div>
    </div>

    <div class="tech-split">
      <div class="tech-panel">
        <h3 class="panel-title">Top 5 งานค้าง (Scheduled)</h3>
        <div id="techTop5" class="top5"></div>
      </div>

      <div class="tech-panel">
        <h3 class="panel-title">รายการช่างทั้งหมด</h3>
        <div id="technician-list" class="tech-grid"></div>
      </div>
    </div>
  </div>

  <!-- Drilldown Modal -->
  <div id="techModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" onclick="closeTechModal()"></div>
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div class="modal-title" id="mName">Technician</div>
          <div class="muted" id="mMeta" style="margin-top:4px"></div>
        </div>
        <button class="chip" onclick="closeTechModal()">ปิด</button>
      </div>

      <div class="modal-tabs">
        <button class="chip primary" id="tabScheduled" onclick="switchModalTab('scheduled')">Scheduled</button>
        <button class="chip" id="tabCompleted" onclick="switchModalTab('completed')">Completed</button>
      </div>

      <div id="modalList" class="modal-list"></div>
    </div>
  </div>
</section>

  </main>

  <script>
    const APP_NAME    = 'Centralized Database from factory';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyjBCUP144jXxJceurkyOzMznUAZ7aY1VYwnX24TxiyQoyYG42n2mk2SrPLjTnhHkuIqA/exec';
    const API_TOKEN   = '0992183266';

    /* ===== Router ===== */
    const titleMap = {
      home:"Maintenance",
      report:"การแจ้งซ่อม",
      success:"การแจ้งซ่อม",
      status:"สถานะการแจ้งซ่อม",
      update:"Update งานซ่อม",
      powerbi:"Power BI",
      guide:"คู่มือ",
      technician:"เจ้าหน้าที่ซ่อมบำรุง"
    };

    function show(view){
      document.querySelectorAll('[data-view]').forEach(el=>el.classList.remove('active'));
      const el = document.querySelector(`[data-view="${view}"]`);
      if (el) el.classList.add('active');

      document.getElementById('title').textContent = titleMap[view] || 'Maintenance';
      document.title = `${titleMap[view] || 'Maintenance'} · ${APP_NAME}`;
      history.replaceState(null, '', `#${view}`);
      window.scrollTo({top:0, behavior:'smooth'});

      if(view === 'technician') fetchTechnicianRequests();
      
      if(view === 'status') renderTable();

      if(view === 'report'){
        setAutoDateTime();
        if(!window.__MASTER_LOADED__){
          window.__MASTER_LOADED__ = true;
          initMachineDropdowns();
        }
      }
    }

    function go(view){ show(view); }

    window.addEventListener('load', () => {
      const initial = (location.hash || '#home').slice(1);
      show(initial);
      setAutoDateTime();
    });

    /* ===== utils ===== */
    function toISODate(d){
      const z = new Date(d);
      z.setMinutes(z.getMinutes() - z.getTimezoneOffset());
      return z.toISOString().slice(0,10);
    }

    function setAutoDateTime(){
      const now = new Date();
      const RequestDate = now.toLocaleDateString('en-CA');
      const TimeRequest = now.toTimeString().slice(0,5);
      const d = document.getElementById('RequestDateShow');
      const t = document.getElementById('TimeRequestShow');
      if(d) d.value = RequestDate;
      if(t) t.value = TimeRequest;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    
    function formatDateOnly(v){
  if(v == null) return '';
  const s = String(v).trim();

  // ถ้าเป็น ISO เช่น 2026-02-26T17:00:00.000Z → เอาแค่ 2026-02-26
  if (/^\d{4}-\d{2}-\d{2}T/.test(s)) return s.slice(0,10);

  // ถ้าเป็นแบบ YYYY-MM-DD อยู่แล้ว
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // ถ้าเป็น Date string อื่นๆ ลอง parse
  const d = new Date(s);
  if(!isNaN(d)) return d.toLocaleDateString('en-CA'); // YYYY-MM-DD

  return s;
}

function formatTimeOnly(v){
  if(v == null) return '';
  const s = String(v).trim();

  // ISO เช่น 1899-12-30T00:57:56.000Z → เอาแค่ 00:57
  if (/^\d{4}-\d{2}-\d{2}T/.test(s)) return s.slice(11,16);

  // ถ้าเป็น HH:mm หรือ HH:mm:ss
  if (/^\d{2}:\d{2}(:\d{2})?$/.test(s)) return s.slice(0,5);

  // ถ้าเป็นตัวเลข (กรณีชีตส่งเวลามาเป็น fraction ของวัน เช่น 0.5)
  const n = Number(s);
  if (!isNaN(n)) {
    const totalMin = Math.round(n * 24 * 60);
    const hh = String(Math.floor(totalMin / 60) % 24).padStart(2,'0');
    const mm = String(totalMin % 60).padStart(2,'0');
    return `${hh}:${mm}`;
  }

  // fallback: ลอง parse เป็น Date
  const d = new Date(s);
  if(!isNaN(d)) return d.toTimeString().slice(0,5);

  return s;
}

function renderStatusPill(stNorm){
  if(stNorm === 'completed'){
    return `<span class="pill completed"><span class="dot"></span>Completed</span>`;
  }

  return `<span class="pill"><span class="dot"></span>Scheduled</span>`;
}

    async function fetchJSON(url, options){
      const res = await fetch(url, options);
      const text = await res.text();
      try{ return JSON.parse(text); }
      catch(e){ throw new Error(`Bad response (${res.status}): ${text.slice(0,200)}`); }
    }

    /* =========================================================
      LIVE APIs (Apps Script)
    ========================================================= */
    async function apiCreateTicket(payload){
      const body = new URLSearchParams({ action:'create', token: API_TOKEN, ...payload }).toString();
      return fetchJSON(WEB_APP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body
      });
    }

    async function apiListTickets(limit=500){
      return fetchJSON(`${WEB_APP_URL}?action=list&limit=${limit}&token=${encodeURIComponent(API_TOKEN)}`);
    }

    async function apiUpdateJob(payload){
      const body = new URLSearchParams({ action:'updateJob', token: API_TOKEN, ...payload }).toString();
      return fetchJSON(WEB_APP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body
      });
    }

    async function apiGetMachineMaster(){
      return fetchJSON(`${WEB_APP_URL}?action=machinemaster&token=${encodeURIComponent(API_TOKEN)}`);
    }

    /* =========================================================
      TICKETS UI
    ========================================================= */
    document.getElementById('ticketForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());

      const now = new Date();
      const RequestDate = now.toLocaleDateString('en-CA');
      const TimeRequest = now.toTimeString().slice(0,5);

      const payload = {
        RequestDate,
        TimeRequest,
        "Machine Section": data.dept || '',
        Machine: data.machine || '',
        Repairdescription: data.desc || '',
        Assigned: data.assignedTo || '',
        Status: 'Scheduled'
      };

      try{
        const r = await apiCreateTicket(payload);
        if(r.ok){
          e.target.reset();
          setAutoDateTime();
          go('success');
        } else {
          alert('บันทึกไม่สำเร็จ: ' + (r.error || 'unknown'));
        }
      } catch(err){
        alert('เครือข่ายผิดพลาด: ' + err.message);
      }
    });

    function nowBangkokText(){
      const d = new Date();
      // ให้เป็นแนวเดียวกับที่คุณใช้ในชีต (dd/MM/yyyy HH:mm)
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
    } 

    function openUpdate(ticket){
      document.getElementById('uId').value = ticket.id || '';
      document.getElementById('uWoHidden').value = ticket.workOrderNo || '';
      document.getElementById('uWorkOrder').textContent = ticket.workOrderNo || '-';
      document.getElementById('uMachine').textContent = ticket.machine || '-';

      document.getElementById('uSupervisor').value = '';
      document.getElementById('uTimeToRepair').value = '';
      document.getElementById('uDepartment').value = '';
      
      const preview = document.getElementById('uCompletedPreview');
      if(preview) preview.textContent = nowBangkokText();
      
      go('update');
    }

    document.getElementById('updateForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());

      const payload = {
        id: data.id || '',
        "Work Order No.": data.workOrderNo || '',
        Supervisor: data.supervisor || '',
        Department: data.department || '',
        "Time to repair": data.timeToRepair || '',
        Status: 'Completed'
      };

      try{
        const r = await apiUpdateJob(payload);
        if(r.ok){
          go('status');
        } else {
          alert('อัปเดตไม่สำเร็จ: ' + (r.error || 'unknown'));
        }
      } catch(err){
        alert('เครือข่ายผิดพลาด: ' + err.message);
      }
    });

    async function renderTable(){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';

  try{
    const r = await apiListTickets(500);

    const rows = (r.rows || []).map(x => ({
      id: x['ID'] || x['id'] || x.id || '',
      workOrderNo: x['WorkOrderNo'] || x['Work Order No.'] || x['Work Order No'] || x.workOrderNo || '',
      RequestDate: x['RequestDate'] || x.RequestDate || '',
      TimeRequest: x['TimeRequest'] || x.TimeRequest || '',
      dept: x['Machine Section'] || x['Machine Department'] || x.dept || '',
      machine: x['Machine'] || x['Machine Name'] || x.machine || '',
      desc: x['Repairdescription'] || x['Problem Description'] || x.desc || '',
      status: x['Status'] || x.status || 'Scheduled',     // ✅ ใส่ comma ตรงนี้
      completedDate: x['CompletedDate'] || x.completedDate || ''
    }));

    let s=0,c=0;
    tbody.innerHTML = '';

    for(const row of rows){
      const stNorm = String(row.status || '').trim().toLowerCase();
      if(stNorm === 'scheduled') s++;
      else if(stNorm === 'completed') c++;

      const statusPill = renderStatusPill(stNorm);
      const canUpdate = (stNorm === 'scheduled') && String(row.id || '').trim() !== '';

      const actionCell = (stNorm === 'completed')
        ? `<span class="muted">${escapeHtml(row.completedDate || '-')}</span>`
        : (canUpdate
            ? `<button class="chip primary" data-action="openUpdate" data-id="${escapeHtml(row.id)}">Update</button>`
            : `<span class="muted">—</span>`);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(row.workOrderNo || '')}</td>
        <td>${escapeHtml(formatDateOnly(row.RequestDate || ''))}</td>
        <td>${escapeHtml(formatTimeOnly(row.TimeRequest || ''))}</td>
        <td>${escapeHtml(row.dept || '')}</td>
        <td>${escapeHtml(row.machine || '')}</td>
        <td>${escapeHtml(row.desc || '')}</td>
        <td>${statusPill}</td>
        <td>${actionCell}</td>   <!-- ✅ ใช้ actionCell -->
      `;
      tbody.appendChild(tr);
    }

    document.getElementById('kScheduled').textContent = s;
    document.getElementById('kCompleted').textContent = c;

    window.__LAST_TICKETS__ = rows;

  } catch(e){
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="8">Load failed: ${escapeHtml(e.message)}</td></tr>`;
  }
}

    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-action="openUpdate"]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const rows = window.__LAST_TICKETS__ || [];
      const t = rows.find(x => String(x.id) === String(id));
      if(t) openUpdate(t);
    });

    /* =========================================================
      Machine master → datalist
    ========================================================= */
    let __MM__ = { sections: [], machinesBySection: {} };

    function fillDatalist(el, items){
      el.innerHTML = '';
      (items || []).forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v;
        el.appendChild(opt);
      });
    }

    function normalizeKey(s){ return String(s||'').trim(); }

    async function initMachineDropdowns(){
      const deptInput = document.getElementById('deptInput');
      const machineInput = document.getElementById('machineInput');
      const deptList = document.getElementById('deptList');
      const machineList = document.getElementById('machineList');

      if(!deptInput || !machineInput || !deptList || !machineList) return;

      try{
        const r = await apiGetMachineMaster();
        if(!r || r.ok === false) throw new Error(r?.error || 'machineMaster_failed');

        // รองรับทั้ง {machinesBySection} หรือ {map}
        const machinesBySection = r.machinesBySection || r.map || {};
        const sections = r.sections || Object.keys(machinesBySection);

        __MM__ = { sections, machinesBySection };

        fillDatalist(deptList, __MM__.sections);

        const onDeptChange = ()=>{
          const sec = normalizeKey(deptInput.value);
          const machines = __MM__.machinesBySection[sec] || [];
          fillDatalist(machineList, machines);

          if(machines.length && machineInput.value && !machines.includes(machineInput.value)){
            machineInput.value = '';
          }
        };

        deptInput.addEventListener('input', onDeptChange);
        deptInput.addEventListener('change', onDeptChange);

      } catch(err){
        console.error(err);
        // fallback: ไม่ให้พัง แค่ปล่อยให้พิมพ์เองได้
      }
    }

  function renderTechnicianRequests(requests) {
  const technicianList = document.getElementById('technician-list');
  technicianList.innerHTML = '';

  if (!requests || !requests.length) {
    technicianList.innerHTML = `<div class="muted">ไม่มีข้อมูล</div>`;
    return;
  }

  requests.forEach(request => {
    const div = document.createElement('div');
    div.classList.add('technician');

    div.innerHTML = `
      <h3>${escapeHtml(request.Technician || request.technician || '-')}</h3>
      <p>Scheduled: ${escapeHtml(request.scheduledCount ?? 0)} งาน</p>
      <p>Completed: ${escapeHtml(request.completedCount ?? 0)} งาน</p>
      <p>Machine Section: ${escapeHtml(request.machineSection ?? '-')}</p>
    `;

    technicianList.appendChild(div);
  });
}

    // ========= Technician state =========
window.__TECH_CACHE__ = [];
window.__TECH_DETAILS_CACHE__ = {}; // name -> details rows
window.__TECH_MODAL_TAB__ = 'scheduled';

async function apiTechnicianSummary(){
  return fetchJSON(`${WEB_APP_URL}?action=technician&token=${encodeURIComponent(API_TOKEN)}`);
}

// NEW: ดึงรายละเอียดงานของช่าง
async function apiTechnicianDetails(name){
  const url = `${WEB_APP_URL}?action=technicianDetails&name=${encodeURIComponent(name)}&token=${encodeURIComponent(API_TOKEN)}`;
  return fetchJSON(url);
}

function unique(arr){ return [...new Set(arr.filter(Boolean))]; }

function buildSectionFilter(rows){
  const sel = document.getElementById('techSectionFilter');
  if(!sel) return;

  const sections = unique(rows.map(r => String(r.machineSection || '').trim())).sort();
  const current = sel.value || '';

  sel.innerHTML = `<option value="">ทุก Machine Section</option>` + sections.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
  sel.value = sections.includes(current) ? current : '';
}

function renderTop5(rows){
  const box = document.getElementById('techTop5');
  if(!box) return;

  const sorted = [...rows].sort((a,b)=> Number(b.scheduledCount||0) - Number(a.scheduledCount||0)).slice(0,5);
  if(!sorted.length){
    box.innerHTML = `<div class="muted">ไม่มีข้อมูล</div>`;
    return;
  }

  box.innerHTML = '';
  sorted.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'top5-item';
    div.innerHTML = `
      <div>
        <b>${escapeHtml(r.Technician || r.technician || '-')}</b>
        <div class="muted" style="font-weight:800;margin-top:4px;">${escapeHtml(r.machineSection || '-')}</div>
      </div>
      <div class="count">+${Number(r.scheduledCount||0)}</div>
    `;
    div.onclick = ()=> openTechModal(String(r.Technician || r.technician || '').trim());
    box.appendChild(div);
  });
}

function renderTechnicianCards(rows){
  const list = document.getElementById('technician-list');
  if(!list) return;

  const q = (document.getElementById('techSearch')?.value || '').trim().toLowerCase();
  const secFilter = (document.getElementById('techSectionFilter')?.value || '').trim();

  const filtered = (rows || []).filter(r=>{
    const name = String(r.Technician || r.technician || '').toLowerCase();
    const sec  = String(r.machineSection || '').trim();
    const okName = !q || name.includes(q);
    const okSec  = !secFilter || sec === secFilter;
    return okName && okSec;
  });

  // KPI
  const totalTech = filtered.length;
  const totalScheduled = filtered.reduce((sum, r) => sum + Number(r.scheduledCount || 0), 0);
  const totalCompleted = filtered.reduce((sum, r) => sum + Number(r.completedCount || 0), 0);

  const kTech = document.getElementById('kTech');
  const kSch  = document.getElementById('kTechScheduled');
  const kCom  = document.getElementById('kTechCompleted');
  if (kTech) kTech.textContent = totalTech;
  if (kSch)  kSch.textContent  = totalScheduled;
  if (kCom)  kCom.textContent  = totalCompleted;

  if(!filtered.length){
    list.innerHTML = `<div class="muted">ไม่พบข้อมูลตามเงื่อนไข</div>`;
    return;
  }

  list.innerHTML = '';
  filtered.forEach(r=>{
    const name = String(r.Technician || r.technician || '-');
    const s = Number(r.scheduledCount || 0);
    const c = Number(r.completedCount || 0);
    const total = s + c;
    const pct = total ? Math.round((c/total)*100) : 0;

    const card = document.createElement('div');
    card.className = 'tech-card';
    card.innerHTML = `
      <h3 class="tech-name">${escapeHtml(name)}</h3>

      <div class="badges">
        <span class="badge scheduled"><span class="mini-dot"></span>Scheduled: ${s}</span>
        <span class="badge completed"><span class="mini-dot"></span>Completed: ${c}</span>
      </div>

      <div class="tech-meta">
        <span>Machine Section</span>
        <span>${escapeHtml(r.machineSection || '-')}</span>
      </div>

      <div class="progress" title="${pct}% completed">
        <div style="width:${pct}%"></div>
      </div>

      <div class="muted" style="margin-top:8px;font-weight:900;font-size:13px;">
        คลิกเพื่อดูรายละเอียดงาน
      </div>
    `;
    card.onclick = ()=> openTechModal(name.trim());
    list.appendChild(card);
  });
}

async function fetchTechnicianRequests(force=false){
  try{
    // โหลด summary ใหม่ทุกครั้ง (ให้เป็นข้อมูลจริง)
    const r = await apiTechnicianSummary();
    if(!r || r.ok === false) throw new Error(r?.error || 'technician_failed');

    window.__TECH_CACHE__ = r.rows || [];
    buildSectionFilter(window.__TECH_CACHE__);
    renderTop5(window.__TECH_CACHE__);
    renderTechnicianCards(window.__TECH_CACHE__);

  } catch(err){
    console.error(err);
    const list = document.getElementById('technician-list');
    if(list) list.innerHTML = `<div class="muted">Load failed: ${escapeHtml(err.message)}</div>`;
  }
}

// Search / Filter realtime
document.addEventListener('input', (e)=>{
  if(e.target?.id === 'techSearch'){
    renderTechnicianCards(window.__TECH_CACHE__);
  }
});
document.addEventListener('change', (e)=>{
  if(e.target?.id === 'techSectionFilter'){
    renderTechnicianCards(window.__TECH_CACHE__);
  }
});

// ========= Modal Drilldown =========
function showTechModal(){
  const m = document.getElementById('techModal');
  if(!m) return;
  m.classList.add('show');
  m.setAttribute('aria-hidden','false');
}
function closeTechModal(){
  const m = document.getElementById('techModal');
  if(!m) return;
  m.classList.remove('show');
  m.setAttribute('aria-hidden','true');
}

function switchModalTab(tab){
  window.__TECH_MODAL_TAB__ = tab;

  const a = document.getElementById('tabScheduled');
  const b = document.getElementById('tabCompleted');
  if(a && b){
    if(tab === 'scheduled'){
      a.classList.add('primary'); b.classList.remove('primary');
    }else{
      b.classList.add('primary'); a.classList.remove('primary');
    }
  }

  const name = document.getElementById('mName')?.getAttribute('data-name') || '';
  if(name) renderTechModalList(name, window.__TECH_DETAILS_CACHE__[name] || []);
}

function makeJobCard(row){
  const wo = row['Work Order No.'] || row.workOrderNo || '';
  const status = row['Status'] || row.status || '';
  const sec = row['Machine Section'] || row.machineSection || '';
  const mac = row['Machine'] || row.machine || '';
  const desc = row['Repairdescription'] || row.desc || '';
  const reqDate = row['RequestDate'] || '';
  const reqTime = row['TimeRequest'] || '';

  // ถ้ามี ID จะกดไป update ได้
  const id = row['ID'] || row.id || '';

  const canUpdate = String(status).toLowerCase() === 'scheduled' && String(id).trim() !== '';

  return `
    <div class="job-card">
      <div class="job-row">
        <div><b>${escapeHtml(wo)}</b> <span class="muted">(${escapeHtml(status)})</span></div>
        <div class="muted" style="font-weight:900">${escapeHtml(reqDate)} ${escapeHtml(reqTime)}</div>
      </div>

      <div class="job-row">
        <div><span class="muted">Section:</span> <b>${escapeHtml(sec)}</b></div>
        <div><span class="muted">Machine:</span> <b>${escapeHtml(mac)}</b></div>
      </div>

      <div class="muted" style="font-weight:800">${escapeHtml(desc)}</div>

      <div class="job-actions">
        ${canUpdate ? `<button class="chip primary" onclick="openUpdateFromModal('${escapeHtml(id)}')">Open Update</button>` : `<span class="muted">—</span>`}
      </div>
    </div>
  `;
}

function renderTechModalList(name, rows){
  const list = document.getElementById('modalList');
  if(!list) return;

  const tab = window.__TECH_MODAL_TAB__ || 'scheduled';
  const filtered = (rows || []).filter(r => String(r.Status||r.status||'').toLowerCase() === tab);

  if(!filtered.length){
    list.innerHTML = `<div class="muted">ไม่มีงานในสถานะนี้</div>`;
    return;
  }

  list.innerHTML = filtered.map(makeJobCard).join('');
}

async function openTechModal(name){
  if(!name) return;

  const mName = document.getElementById('mName');
  const mMeta = document.getElementById('mMeta');
  if(mName){
    mName.textContent = name;
    mName.setAttribute('data-name', name);
  }

  // meta จาก summary
  const sum = (window.__TECH_CACHE__ || []).find(r => String(r.Technician||r.technician||'').trim() === name.trim());
  if(mMeta && sum){
    mMeta.textContent = `Machine Section: ${sum.machineSection || '-'} | Scheduled: ${sum.scheduledCount||0} | Completed: ${sum.completedCount||0}`;
  }

  showTechModal();
  switchModalTab('scheduled'); // default

  // cache details
  try{
    if(!window.__TECH_DETAILS_CACHE__[name]){
      const r = await apiTechnicianDetails(name);
      if(!r || r.ok === false) throw new Error(r?.error || 'technicianDetails_failed');
      window.__TECH_DETAILS_CACHE__[name] = r.rows || [];
    }
    renderTechModalList(name, window.__TECH_DETAILS_CACHE__[name]);

  }catch(err){
    console.error(err);
    const list = document.getElementById('modalList');
    if(list) list.innerHTML = `<div class="muted">Load failed: ${escapeHtml(err.message)}</div>`;
  }
}

// เปิดหน้า update โดยใช้ข้อมูลจากตาราง status ที่มีอยู่แล้ว
function openUpdateFromModal(id){
  closeTechModal();
  // ใช้ข้อมูลที่โหลดไว้ใน status table (ถ้ายังไม่เคยเข้า status อาจยังไม่มี)
  const rows = window.__LAST_TICKETS__ || [];
  const t = rows.find(x => String(x.id) === String(id));
  if(t){
    openUpdate(t);
  }else{
    // fallback: ไปหน้า status ให้โหลดก่อน
    go('status');
    setTimeout(()=>alert('ไปหน้า Status แล้วกด Update รายการนั้นอีกครั้ง (ยังไม่มี cache รายการในหน้านี้)'), 50);
  }
}
  </script>
  
</body>
</html>






