<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maintenance Portal</title>
  <meta name="application-name" content="Maintenance Portal">
  <meta name="apple-mobile-web-app-title" content="Maintenance Portal">

  <style>
    :root{
      --brand:#9e2f1c;
      --bg:#fff9f7;
      --text:#1e1e1e;
      --muted:#6b6b6b;
      --card:#ffffff;
      --radius:18px;
      --shadow:0 6px 18px rgba(0,0,0,.12);
    }

    * , *::before, *::after{ box-sizing:border-box; }
    html,body{height:100%;}

    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "TH Sarabun New", Tahoma, sans-serif;
      color:var(--text);
      background:var(--bg);
      font-size:16px;
      line-height:1.5;
    }

    .topbar{
      position:sticky; top:0; z-index:20;
      background:var(--brand); color:#fff;
      padding:14px 18px;
      display:flex; align-items:center; gap:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    .topbar h1{
      font-size:20px;
      margin:0;
      font-weight:800;
      letter-spacing:.3px
    }

    .back{
      appearance:none;
      border:0;
      cursor:pointer;
      width:40px;
      height:40px;
      border-radius:999px;
      display:grid;
      place-items:center;
      color:#fff;
      background: rgba(255,255,255,.14);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.18),
        0 6px 14px rgba(0,0,0,.18);
      font-size:20px;
      line-height:1;
    }

    .container{
      max-width: 520px;
      margin:0 auto;
      padding: 22px 18px 78px;
    }
    @media (min-width: 640px){
      .container{ max-width: 920px; }
    }
    @media (min-width: 1024px){
      .container{
        max-width: 1240px;
        padding: 28px 26px 40px;
      }
    }

    [data-view]{display:none}
    [data-view].active{display:block}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      margin:18px 0;
    }
    .muted{color:var(--muted)}

    .hero{ width:100%; text-align:center; margin: 18px 0 18px; }
    .hero span{
      font-size: 40px;
      font-weight: 900;
      color:var(--brand);
      letter-spacing:0.6px;
    }
    .menu{
      display:flex;
      flex-direction:column;
      gap:18px;
      margin-top:14px;
      max-width: 760px;
      margin-left:auto;
      margin-right:auto;
    }

    .btn{
      display:block;
      width:100%;
      text-align:center;
      text-decoration:none;
      cursor:pointer;
      background:var(--brand);
      color:#fff;
      border:0;
      border-radius:999px;
      padding: 14px 22px;
      font-weight:900;
      box-shadow:0 4px 0 #5f1c11, var(--shadow);
    }
    .btn small{
      display:block;
      font-weight:700;
      font-size: 15px;
      opacity:.92;
      margin-top:2px;
    }

    form{display:grid; gap:14px}
    .field{display:grid; gap:8px; position:relative}
    .field label{ font-weight:800; font-size:20px; line-height:1.35; }
    .field small{color:var(--muted)}
    .field input,.field select,.field textarea{
      width:100%;
      border-radius:12px;
      border:1px solid #ddd;
      padding:12px 12px;
      font-size:16px;
      background:#fff;
      outline-color:var(--brand);
    }
    .field textarea{min-height:96px; resize:vertical}

    .field[data-step]{ padding-left: 60px; }
    .field[data-step]::before{
      content: attr(data-step);
      position:absolute;
      left:20px;
      top:50%;
      transform:translateY(-50%);
      width:30px;
      height:30px;
      display:grid;
      place-items:center;
      background:var(--brand);
      color:#fff;
      border-radius:50%;
      font-weight:900;
      font-size:14px;
      box-shadow:var(--shadow);
    }

    .step{ display:none; }
    .step.active{ display:block; }

    .stepbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      border:1px solid #eee;
      border-radius:14px;
      background:#fff;
      margin: 10px 0 14px;
      box-shadow: 0 4px 14px rgba(0,0,0,.06);
    }
    .stepbar b{ font-size:14px; }
    .progress{
      flex:1;
      height:10px;
      background:#f1f1f1;
      border-radius:999px;
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width:50%;
      background:var(--brand);
      border-radius:999px;
      transition: width .2s ease;
    }
    .step-count{
      font-size:13px;
      color:var(--muted);
      min-width:84px;
      text-align:right;
    }

    .row-actions{
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top: 14px;
    }

    .chip{
      border-radius:999px;
      padding:10px 14px;
      border:1px solid #eee;
      background:#fff;
      font-weight:800;
      cursor:pointer;
      font-size:14px;
      box-shadow: 0 4px 12px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .chip.red{
      background:#ffeceb;
      border-color:#ffeceb;
      color:#7a1b12;
    }

    .kpi{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      margin: 10px 0 14px;
    }
    .kpi .box{
      background:#fff;
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px 14px;
      text-align:center;
    }
    .kpi .box b{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .kpi .box span{
      font-size:28px;
      font-weight:900;
      color:var(--brand);
      line-height:1;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid #eee;
      vertical-align:top
    }
    th{
      background:#fafafa;
      text-align:left;
      color:#444;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    [data-view="status"] .card{ overflow:auto; }

    .modal{
      position:fixed;
      inset:0;
      display:none;
      z-index:50;
      background: rgba(0,0,0,.45);
      padding: 18px;
    }
    .modal.active{ display:grid; place-items:center; }
    .modal .panel{
      width:min(720px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      padding:18px;
    }
    .modal h3{ margin:0 0 10px; font-size:20px; }
    .modal .meta{
      display:grid;
      gap:6px;
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 13px;
    }
    .modal .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .tabbar{
      position:fixed;
      bottom:14px; left:0; right:0;
      display:flex;
      justify-content:center;
      pointer-events:none
    }
    .tabbar .inner{
      pointer-events:auto;
      background:#fff;
      border-radius:999px;
      box-shadow:var(--shadow);
      display:flex;
      gap:8px;
      padding:8px
    }
    .tabbar .inner .chip{ padding:8px 12px; font-size:13px; box-shadow:none; }
    .tabbar .inner .chip small{ display:block; font-weight:500; font-size:11px; opacity:.85; }

    @media (min-width: 1024px){
      .tabbar{ display:none; }
      [data-view="status"] .card,
      [data-view="guide"] .card,
      [data-view="powerbi"] .card{
        max-width: 1120px;
        margin-left:auto;
        margin-right:auto;
        padding: 26px;
      }
      [data-view="guide"] .card{ font-size:18px; line-height:1.7; }
      [data-view="guide"] h2{ font-size:24px; margin-bottom:14px; }
      [data-view="guide"] li{ margin: 10px 0; }
      [data-view="powerbi"] h2{ font-size:24px; }
      [data-view="powerbi"] .muted{ font-size:16px; }
      [data-view="powerbi"] iframe{ border-radius:14px; }
    }

    [data-view="report"] .card{
      max-width: 980px;
      margin-left:auto;
      margin-right:auto;
      padding: 22px;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <button class="back" aria-label="ย้อนกลับ" onclick="go('home')">⟵</button>
    <h1 id="title">Maintenance</h1>
  </div>

  <main class="container">
    <!-- HOME -->
    <section data-view="home" class="active">
      <div class="hero"><span>Maintenance</span></div>
      <div class="menu">
        <button class="btn" onclick="go('report')">แจ้งซ่อม <small>Repair request</small></button>
        <button class="btn" onclick="go('status')">สถานะการแจ้งซ่อม <small>Request status</small></button>
        <button class="btn" onclick="go('powerbi')">Power BI <small>Dashboard</small></button>
        <button class="btn" onclick="go('guide')">คู่มือการใช้งาน <small>User guide</small></button>
      </div>
    </section>

    <!-- REPORT -->
    <section data-view="report">
      <div class="card">
        <h2 style="margin:0 0 8px">การแจ้งซ่อม (Repair Request)</h2>

        <div class="stepbar">
          <b id="stepTitle">Step 1/2</b>
          <div class="progress"><div id="progressFill"></div></div>
          <div class="step-count" id="stepCount">1–8 / 13</div>
        </div>

        <form id="ticketForm">
          <div class="step active" data-step-panel="1">
            <div class="field" data-step="1">
              <label for="RequestDateShow">RequestDate</label>
              <input id="RequestDateShow" type="text" disabled />
              <small>ระบบจะสร้างให้อัตโนมัติ</small>
            </div>

            <div class="field" data-step="2">
              <label for="TimeREquestShow">TimeREquest</label>
              <input id="TimeREquestShow" type="text" disabled />
              <small>ระบบจะสร้างให้อัตโนมัติ</small>
            </div>

            <div class="field" data-step="3">
              <label for="dept">Machine Section</label>
              <select id="dept" name="dept" required>
                <option value="" disabled selected>เลือก... / Select...</option>
                <option>P3/1</option>
                <option>P3/2</option>
                <option>P3/3</option>
                <option>P4/1</option>
              </select>
            </div>

            <div class="field" data-step="4">
              <label for="machine">Machine</label>
              <input id="machine" name="machine" type="text" placeholder="เช่น เครื่องตัด... / e.g. Cutting machine" required />
            </div>

            <div class="field" data-step="5">
              <label for="desc">Repairdescription</label>
              <textarea id="desc" name="desc" placeholder="เล่าอาการ/ตำแหน่ง/เงื่อนไขที่พบ (Describe problem / location / condition)" required></textarea>
            </div>

            <div class="field" data-step="6">
              <label for="preorder">Pre order</label>
              <input id="preorder" name="preorder" type="text" placeholder="ถ้ามีให้กรอก (Optional)" />
            </div>

            <div class="field" data-step="7">
              <label for="assignedTo">Assigned</label>
              <input id="assignedTo" name="assignedTo" type="text" placeholder="ชื่อช่าง/ผู้รับงาน (Optional)" />
            </div>

            <div class="field" data-step="8">
              <label for="department">Department</label>
              <select id="department" name="department" required>
                <option value="" disabled selected>เลือก... / Select...</option>
                <option>Mechanical</option>
                <option>Electrical</option>
                <option>Mold</option>
                <option>PM</option>
              </select>
            </div>

            <div class="row-actions">
              <span></span>
              <button type="button" class="btn" onclick="nextStep()">ถัดไป <small>Next</small></button>
            </div>
          </div>

          <div class="step" data-step-panel="2">
            <div class="field" data-step="9">
              <label for="supervisor">Supervisor</label>
              <input id="supervisor" name="supervisor" type="text" placeholder="ชื่อหัวหน้าหรือผู้ตรวจ (Optional)" />
            </div>

            <div class="field" data-step="10">
              <label for="workOrderNo">Work Order No.</label>
              <input id="workOrderNo" name="workOrderNo" type="text" placeholder="เช่น WO-0001 (Optional)" />
            </div>

            <div class="field" data-step="11">
              <label for="timeToRepair">Time to repair</label>
              <input id="timeToRepair" name="timeToRepair" type="text" placeholder="เช่น 2.5 hrs / 150 min (Optional)" />
            </div>

            <div class="field" data-step="12">
              <label for="scheduledDate">ScheduledDate</label>
              <input id="scheduledDate" name="scheduledDate" type="date" />
              <small>ถ้ายังไม่กำหนดให้เว้นว่างได้</small>
            </div>

            <div class="field" data-step="13">
              <label for="status">Status</label>
              <select id="status" name="status">
                <option value="Scheduled" selected>Scheduled</option>
                <option value="Completed">Completed</option>
                <option value="Overdue">Overdue</option>
              </select>
              <small>ค่าเริ่มต้น Scheduled</small>
            </div>

            <div class="row-actions">
              <button type="button" class="chip" onclick="prevStep()">⟵ ย้อนกลับ</button>
              <button class="btn" type="submit">ส่งคำขอซ่อม <small>Submit request</small></button>
            </div>
          </div>
        </form>

        <p class="muted" style="margin-top:12px">
          *หมายเหตุ:* ระบบจะสร้าง <code>RequestDate</code> และ <code>TimeREquest</code> ให้อัตโนมัติจากเวลาปัจจุบัน
        </p>
      </div>
    </section>

    <!-- SUCCESS -->
    <section data-view="success">
      <div class="card" style="text-align:center">
        <h2>การแจ้งซ่อมเสร็จสิ้น (Request Submitted)</h2>
        <p class="muted">ระบบได้บันทึกคำขอไว้แล้ว / Your request has been recorded.</p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:14px; flex-wrap:wrap">
          <button class="chip" onclick="go('status')">ดูสถานะ<br><small>View status</small></button>
          <button class="chip" onclick="go('home')">กลับหน้าแรก<br><small>Back to home</small></button>
        </div>
      </div>
    </section>

    <!-- STATUS -->
    <section data-view="status">
      <div class="kpi">
        <div class="box"><b>Scheduled</b><span id="kScheduled">0</span></div>
        <div class="box"><b>Completed</b><span id="kCompleted">0</span></div>
        <div class="box"><b>Overdue</b><span id="kOverdue">0</span></div>
      </div>

      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <h3 style="margin:0; font-size:20px">รายการคำขอ (Request List)</h3>
          <button class="chip" onclick="renderTable()">Refresh</button>
        </div>

        <table id="tbl" style="margin-top:12px">
          <thead>
            <tr>
              <th>WorkOrderNo</th>
              <th>RequestDate</th>
              <th>Time</th>
              <th>Machine Section</th>
              <th>Machine</th>
              <th>Description</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <p class="muted" style="margin:12px 0 0">
          *กดปุ่ม “Update” เฉพาะรายการที่เป็น Scheduled เพื่อกรอก Supervisor / Time to repair / Department แล้วระบบจะเปลี่ยนเป็น Completed
        </p>
      </div>
    </section>

    <!-- POWER BI (✅ อยู่ครบ) -->
    <section data-view="powerbi">
      <div class="card">
        <h2 style="margin:0 0 12px">Power BI Dashboard</h2>
        <p class="muted">ใส่ลิงก์ Embed ของ Power BI แทน <code>IFRAME</code> ด้านล่างนี้ / Replace src with your Power BI embed link.</p>

        <div style="display:grid; gap:14px">
          <iframe title="Overview"
            style="width:100%; aspect-ratio:16/9; border:0; background:#fafafa"
            src="https://app.powerbi.com/view?r=eyJrIjoiYWM2MDViNTEtNGU4Mi00ODVlLTk4ZmItMzgzMTg1YzdjNDUxIiwidCI6ImY5MGM0NjQ3LTg4NmYtNGI0Yy1iMmViLTU1NWRmOWVjNGU4MSIsImMiOjEwfQ%3D%3D"
            allowfullscreen></iframe>

          <iframe title="Maintenance Wise"
            style="width:100%; aspect-ratio:16/9; border:0; background:#fafafa"
            src="https://app.powerbi.com/view?r=eyJrIjoiYWM2MDViNTEtNGU4Mi00ODVlLTk4Zm-it"
            allowfullscreen></iframe>
        </div>
      </div>
    </section>

    <!-- GUIDE (✅ อยู่ครบ) -->
    <section data-view="guide">
      <div class="card">
        <h2 style="margin:0 0 10px">คู่มือการใช้งาน (User Guide)</h2>
        <ol>
          <li>กด “แจ้งซ่อม (Repair request)” กรอก Step 1 แล้วกด “ถัดไป” เพื่อไป Step 2</li>
          <li>ใน Step 2 ตรวจสอบข้อมูล แล้วกด “ส่งคำขอซ่อม”</li>
          <li>ดูรายการและนับงานใน “สถานะการแจ้งซ่อม (Request status)”</li>
          <li>หากต้องการปิดงาน ให้กด “Update” ที่รายการ Scheduled แล้วกรอกข้อมูลปิดงาน</li>
          <li>ฝังรายงานจริงใน “Power BI Dashboard” ด้วยลิงก์ Embed</li>
        </ol>
        <p class="muted">*ไฟล์นี้เป็น Single-File HTML — อัปโหลดขึ้น GitHub Pages/เว็บเซิร์ฟเวอร์แล้วเปิดใช้งานได้ทันที</p>
      </div>
    </section>
  </main>

  <!-- UPDATE MODAL -->
  <div class="modal" id="updateModal" aria-hidden="true">
    <div class="panel">
      <h3>Update งานซ่อม (Close job)</h3>
      <div class="meta" id="updateMeta"></div>

      <form id="updateForm">
        <input type="hidden" id="u_id" name="id" />

        <div class="field">
          <label for="u_supervisor">Supervisor</label>
          <input id="u_supervisor" name="supervisor" type="text" placeholder="ชื่อผู้ตรวจ/หัวหน้า" required />
        </div>

        <div class="field">
          <label for="u_timeToRepair">Time to repair</label>
          <input id="u_timeToRepair" name="timeToRepair" type="text" placeholder="เช่น 30 min / 2 hrs" required />
        </div>

        <div class="field">
          <label for="u_department">Department</label>
          <select id="u_department" name="department" required>
            <option value="" disabled selected>เลือก... / Select...</option>
            <option>Mechanical</option>
            <option>Electrical</option>
            <option>Mold</option>
            <option>PM</option>
          </select>
        </div>

        <div class="actions">
          <button type="button" class="chip" onclick="closeUpdate()">Cancel</button>
          <button type="submit" class="btn">บันทึกและปิดงาน <small>Save & Complete</small></button>
        </div>
      </form>

      <p class="muted" style="margin:10px 0 0">
        *หมายเหตุ:* ปุ่มนี้จะอัปเดต “บรรทัดเดิม” ใน Google Sheet (ต้องมี Apps Script action=updateTicket)
      </p>
    </div>
  </div>

  <div class="tabbar">
    <div class="inner">
      <button class="chip" onclick="go('home')">Home<br><small>หน้าแรก</small></button>
      <button class="chip" onclick="go('report')">แจ้งซ่อม<br><small>Repair</small></button>
      <button class="chip" onclick="go('status')">สถานะ<br><small>Status</small></button>
      <button class="chip" onclick="go('powerbi')">Power BI<br><small>Dashboard</small></button>
      <button class="chip" onclick="go('guide')">คู่มือ<br><small>Guide</small></button>
    </div>
  </div>

  <script>
    /* ===== Config ===== */
    const APP_NAME    = 'Centralized Database from factory';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxoGPh-Q175O0rfbm0tA8B6tjb5TSvVgPxmuZ0CqI79wUP8zuEqbBWsJj5sYPTdiQaljA/exec';
    const API_TOKEN   = '0992183266';

    const titleMap = {
      home:"Maintenance",
      report:"การแจ้งซ่อม",
      success:"การแจ้งซ่อม",
      status:"สถานะการแจ้งซ่อม",
      powerbi:"Power BI",
      guide:"คู่มือการใช้งาน"
    };

    function show(view){
      document.querySelectorAll('[data-view]').forEach(el=>el.classList.remove('active'));
      const el = document.querySelector(`[data-view="${view}"]`);
      if (el) el.classList.add('active');

      document.getElementById('title').textContent = titleMap[view] || 'Maintenance';
      document.title = `${titleMap[view] || 'Maintenance'} · ${APP_NAME}`;
      history.replaceState(null, '', `#${view}`);
      window.scrollTo({top:0, behavior:'smooth'});

      if(view === 'status') renderTable();
      if(view === 'report'){
        resetStep();
        setAutoDateTime();
      }
    }
    function go(view){ show(view); }

    window.addEventListener('load', () => {
      const initial = (location.hash || '#home').slice(1);
      show(initial);
      setAutoDateTime();
    });

    let currentStep = 1;

    function setAutoDateTime(){
      const now = new Date();
      const RequestDate = now.toLocaleDateString('en-CA');
      const TimeREquest = now.toTimeString().slice(0,5);
      const d = document.getElementById('RequestDateShow');
      const t = document.getElementById('TimeREquestShow');
      if(d) d.value = RequestDate;
      if(t) t.value = TimeREquest;
    }

    function showStep(n){
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      const target = document.querySelector(`.step[data-step-panel="${n}"]`);
      if(target) target.classList.add('active');
      currentStep = n;

      const title = document.getElementById('stepTitle');
      const count = document.getElementById('stepCount');
      const fill = document.getElementById('progressFill');

      if(n === 1){
        title.textContent = 'Step 1/2';
        count.textContent = '1–8 / 13';
        fill.style.width = '50%';
      }else{
        title.textContent = 'Step 2/2';
        count.textContent = '9–13 / 13';
        fill.style.width = '100%';
      }
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function nextStep(){
      const requiredIds = ['dept','machine','desc','department'];
      for(const id of requiredIds){
        const el = document.getElementById(id);
        if(el && !el.checkValidity()){
          el.reportValidity();
          return;
        }
      }
      showStep(2);
    }
    function prevStep(){ showStep(1); }
    function resetStep(){ showStep(1); }

    async function fetchJSON(url, options){
      const res = await fetch(url, options);
      const text = await res.text();
      try{ return JSON.parse(text); }
      catch(e){ throw new Error(`Bad response (${res.status}): ${text.slice(0,200)}`); }
    }

    async function apiCreateTicket(payload){
      const body = new URLSearchParams({ action:'create', token: API_TOKEN, ...payload }).toString();
      return fetchJSON(WEB_APP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body
      });
    }

    async function apiListTickets(limit=500){
      return fetchJSON(`${WEB_APP_URL}?action=list&limit=${limit}`);
    }

    async function apiUpdateTicket(payload){
      const body = new URLSearchParams({ action:'updateTicket', token: API_TOKEN, ...payload }).toString();
      return fetchJSON(WEB_APP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body
      });
    }

    document.getElementById('ticketForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());

      const now = new Date();
      const RequestDate = now.toLocaleDateString('en-CA');
      const TimeREquest = now.toTimeString().slice(0,5);

      const payload = {
        RequestDate,
        TimeREquest,
        "Machine Section": data.dept || '',
        Machine: data.machine || '',
        Repairdescription: data.desc || '',
        "Pre order": data.preorder || '',
        Assigned: data.assignedTo || '',
        Department: data.department || '',
        Supervisor: data.supervisor || '',
        "Work Order No.": data.workOrderNo || '',
        "Time to repair": data.timeToRepair || '',
        ScheduledDate: data.scheduledDate || '',
        Status: data.status || 'Scheduled',
      };

      try{
        const r = await apiCreateTicket(payload);
        if(r.ok){
          e.target.reset();
          resetStep();
          go('success');
        } else {
          alert('บันทึกไม่สำเร็จ: ' + (r.error || 'unknown'));
        }
      } catch(err){
        alert('เครือข่ายผิดพลาด: ' + err.message);
      }
    });

    let LAST_ROWS = [];

    function pick(obj, keys){
      for(const k of keys){
        if(obj && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== ''){
          return obj[k];
        }
      }
      return '';
    }

    function normalizeDate(v){
      if(!v) return '';
      const s = String(v);
      if(s.includes('T')) return s.slice(0,10);
      return s;
    }

    async function renderTable(){
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';

      let rows = [];
      try{
        const r = await apiListTickets(500);
        rows = (r.rows||[]).map(x=>({
          id: pick(x, ['ID','id']),
          workOrderNo: pick(x, ['Work Order No.','WorkOrderNo']),
          requestDate: normalizeDate(pick(x, ['RequestDate','Request Date'])),
          timeRequest: pick(x, ['TimeREquest','Request Time','TimeRequest']),
          machineSection: pick(x, ['Machine Section','Machine Department','MachineSection']),
          machine: pick(x, ['Machine','Machine Name','MachineName']),
          desc: pick(x, ['Repairdescription','Problem Description','Description']),
          status: pick(x, ['Status']) || 'Scheduled',
          supervisor: pick(x, ['Supervisor']),
          department: pick(x, ['Department']),
          timeToRepair: pick(x, ['Time to repair','TimeToRepair'])
        }));
      } catch(e){
        tbody.innerHTML = `<tr><td colspan="8">Load failed (${escapeHtml(e.message)})</td></tr>`;
        document.getElementById('kScheduled').textContent=0;
        document.getElementById('kCompleted').textContent=0;
        document.getElementById('kOverdue').textContent=0;
        return;
      }

      LAST_ROWS = rows;

      let s=0,c=0,o=0;
      tbody.innerHTML='';
      for(const r of rows){
        if(r.status==='Scheduled') s++;
        else if(r.status==='Completed') c++;
        else o++;

        const canUpdate = (r.status === 'Scheduled');
        const actionHtml = canUpdate
          ? `<button class="chip red" data-action="openUpdate" data-id="${escapeHtml(r.id)}">Update</button>`
          : `—`;

        const statusBadge = `<span class="chip">${escapeHtml(r.status)}</span>`;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.workOrderNo||'')}</td>
          <td>${escapeHtml(r.requestDate||'')}</td>
          <td>${escapeHtml(r.timeRequest||'')}</td>
          <td>${escapeHtml(r.machineSection||'')}</td>
          <td>${escapeHtml(r.machine||'')}</td>
          <td>${escapeHtml(r.desc||'')}</td>
          <td>${statusBadge}</td>
          <td>${actionHtml}</td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById('kScheduled').textContent=s;
      document.getElementById('kCompleted').textContent=c;
      document.getElementById('kOverdue').textContent=o;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function openUpdateById(id){
      const row = LAST_ROWS.find(x => String(x.id) === String(id));
      if(!row){
        alert('ไม่พบรายการนี้');
        return;
      }

      document.getElementById('u_id').value = row.id;

      document.getElementById('updateMeta').innerHTML = `
        <div><b>Machine:</b> ${escapeHtml(row.machine||'-')}</div>
        <div><b>Section:</b> ${escapeHtml(row.machineSection||'-')}</div>
        <div><b>Request:</b> ${escapeHtml(row.requestDate||'-')} ${escapeHtml(row.timeRequest||'')}</div>
        <div><b>Description:</b> ${escapeHtml(row.desc||'-')}</div>
      `;

      document.getElementById('u_supervisor').value = row.supervisor || '';
      document.getElementById('u_timeToRepair').value = row.timeToRepair || '';
      const dep = document.getElementById('u_department');
      dep.selectedIndex = 0;
      if(row.department){
        const opt = Array.from(dep.options).find(o=>o.value===row.department);
        if(opt) dep.value = row.department;
      }

      const m = document.getElementById('updateModal');
      m.classList.add('active');
      m.setAttribute('aria-hidden','false');
    }

    function closeUpdate(){
      const m = document.getElementById('updateModal');
      m.classList.remove('active');
      m.setAttribute('aria-hidden','true');
      document.getElementById('updateForm').reset();
    }

    document.getElementById('updateModal').addEventListener('click', (e)=>{
      if(e.target.id === 'updateModal') closeUpdate();
    });

    // ✅ FIX สำคัญ: ส่งชื่อ field ให้ตรงกับ Apps Script (ตัวเล็ก)
    document.getElementById('updateForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());

      const payload = {
        id: data.id,
        supervisor: data.supervisor,
        timeToRepair: data.timeToRepair,
        department: data.department,
        status: 'Completed'
      };

      try{
        const r = await apiUpdateTicket(payload);
        if(r.ok){
          closeUpdate();
          await renderTable();
        }else{
          alert('อัปเดตไม่สำเร็จ: ' + (r.error || 'unknown'));
        }
      } catch(err){
        alert('เครือข่ายผิดพลาด: ' + err.message);
      }
    });

    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-action="openUpdate"]');
      if(btn){
        openUpdateById(btn.getAttribute('data-id'));
      }
    });
  </script>
</body>
</html>
