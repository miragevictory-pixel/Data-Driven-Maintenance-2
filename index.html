<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maintenance Portal</title>
  <meta name="application-name" content="Maintenance Portal">
  <meta name="apple-mobile-web-app-title" content="Maintenance Portal">
  <style>
    :root{
      --brand:#9e2f1c; /* โทนแดงอิฐ */
      --bg:#fff9f7;
      --text:#1e1e1e;
      --muted:#6b6b6b;
      --card:#ffffff;
      --radius:18px;
      --shadow:0 6px 18px rgba(0,0,0,.12);
      *,
*::before,
*::after{
  box-sizing:border-box;
}
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "TH Sarabun New", Tahoma, sans-serif;
      color:var(--text); background:var(--bg);
    }
    /* ====== Top Bar ====== */
    .topbar{
      position:sticky; top:0; z-index:20;
      background:var(--brand); color:#fff; padding:14px 16px;
      display:flex; align-items:center; gap:10px; box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    .topbar h1{font-size:20px; margin:0; font-weight:700; letter-spacing:.3px}
    .back{appearance:none; background:transparent; border:0; color:#fff; font-size:18px; cursor:pointer}
    .container{max-width:420px; margin:0 auto; padding:18px 16px 72px}

    /* ขยายความกว้างอัตโนมัติบนจอใหญ่ เพื่อให้ Power BI เต็มตา */
    @media (min-width: 640px){ .container{ max-width: 720px; } }
    @media (min-width: 1024px){ .container{ max-width: 1100px; } }

    /* ====== Home ====== */
    .hero{
      display:flex; align-items:center; gap:8px; margin:6px 0 18px;
    }
    .hero span:nth-child(1){color:var(--brand); font-weight:700}
    .hero span:nth-child(2){font-weight:300}
    .big-img{width:100%; max-width:500px; margin:18px auto 10px; display:block; opacity:.9}

    .menu{display:flex; flex-direction:column; gap:22px; margin-top:10px}
    .btn{
      display:block; width:100%; text-align:center; text-decoration:none; cursor:pointer;
      background:var(--brand); color:#fff; border:0; border-radius:999px; padding:14px 18px; font-weight:700;
      box-shadow:0 4px 0 #5f1c11, var(--shadow); transition:transform .05s ease;
    }
    .btn small{
      display:block;
      font-weight:400;
      font-size:13px;
      opacity:.9;
      margin-top:2px;
    }
    .btn:active{transform:translateY(1px)}
    .link{color:var(--brand); font-weight:600; text-decoration:none}

    /* ====== Views ====== */
    [data-view]{display:none}
    [data-view].active{display:block}

    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px; margin:14px 0;
    }
    .muted{color:var(--muted)}

    /* ====== Form ====== */
    form{display:grid; gap:14px}
    .field{display:grid; gap:8px; position:relative}
    .field label{font-weight:700}
    .field small{color:var(--muted)}
    .field input,.field select,.field textarea{
      width:100%; border-radius:12px; border:1px solid #ddd; padding:12px 12px; font-size:16px;
      background:#fff; outline-color:var(--brand);
    }
    .field textarea{min-height:96px; resize:vertical}

    /* ให้ฟิลด์ที่มีลำดับมีระยะห่างทางซ้าย ป้องกันเลขกลมทับหัวข้อ */
    .field[data-step]{
      padding-left: 40px;
    }

    /* Numbered bullets like mockup */
    .field[data-step]::before{
      content: attr(data-step);
      position:absolute;
      left:8px;
      top:8px;
      width:26px;
      height:26px;
      display:grid;
      place-items:center;
      background:var(--brand);
      color:#fff;
      border-radius:50%;
      font-weight:800;
      font-size:14px;
      box-shadow:var(--shadow);
    }

    /* ====== Status ====== */
    .kpi{
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin:6px 0 10px;
    }
    .kpi .box{background:#fff; border-radius:14px; box-shadow:var(--shadow); padding:12px; text-align:center}
    .kpi .box b{display:block; font-size:12px; color:var(--muted)}
    .kpi .box span{font-size:22px; font-weight:800; color:var(--brand)}

    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{padding:10px 8px; border-bottom:1px solid #eee; vertical-align:top}
    th{background:#fafafa; text-align:left; color:#444}

    /* ====== Footer Nav (mobile) ====== */
    .tabbar{position:fixed; bottom:14px; left:0; right:0; display:flex; justify-content:center; pointer-events:none}
    .tabbar .inner{pointer-events:auto; background:#fff; border-radius:999px; box-shadow:var(--shadow); display:flex; gap:8px; padding:8px}
    .chip{border-radius:999px; padding:8px 12px; border:1px solid #eee; background:#fff; font-weight:600; cursor:pointer; font-size:14px}
    .chip small{
      display:block;
      font-weight:400;
      font-size:11px;
      opacity:.85;
    }
  </style>
</head>
<body>
  <!-- Top bar (dynamic title) -->
  <div class="topbar">
    <button class="back" aria-label="ย้อนกลับ" onclick="go('home')">⟵</button>
    <h1 id="title">Maintenance</h1>
  </div>

  <main class="container">
    <!-- ============ HOME ============ -->
    <section data-view="home" class="active">
      <div class="hero"><span>Main</span><span>tenance</span></div>
      <!-- ใส่ภาพประกอบเองได้ใน src (หรือปล่อยว่างไว้) -->
      <img class="big-img" alt="illustration" src="" onerror="this.remove()" />

      <div class="menu">
        <button class="btn" onclick="go('report')">
          แจ้งซ่อม
          <small>Repair request</small>
        </button>
        <button class="btn" onclick="go('status')">
          สถานะการแจ้งซ่อม
          <small>Request status</small>
        </button>
        <button class="btn" onclick="go('powerbi')">
          Power BI
          <small>Dashboard</small>
        </button>
        <button class="btn" onclick="go('guide')">
          คู่มือการใช้งาน
          <small>User guide</small>
        </button>
      </div>
    </section>

    <!-- ============ REPORT (FORM) ============ -->
    <section data-view="report">
      <div class="card">
        <h2 style="margin:0 0 8px">การแจ้งซ่อม (Repair Request)</h2>
        <form id="ticketForm">
          <div class="field" data-step="1">
            <label for="reqDate">วันที่แจ้งซ่อม (Request Date)</label>
            <input id="reqDate" name="reqDate" type="date" required />
          </div>
          <div class="field" data-step="2">
            <label for="reqTime">เวลาแจ้งซ่อม (Request Time)</label>
            <input id="reqTime" name="reqTime" type="time" required />
          </div>
          <div class="field" data-step="3">
            <label for="assigned">ชื่อผู้แจ้ง (Requestor Name)</label>
            <input id="assigned" name="assigned" type="text" placeholder="เช่น สมชาย / e.g. Somchai" required />
          </div>
          <div class="field" data-step="4">
            <label for="dept">รหัสแผนก (Machine Department)</label>
            <select id="dept" name="dept" required>
              <option value="" disabled selected>เลือก... / Select...</option>
              <option>P3/1</option>
              <option>P3/2</option>
              <option>P3/3</option>
              <option>P4/1</option>
            </select>
          </div>
          <div class="field" data-step="5">
            <label for="machine">ชื่อเครื่องจักร (Machine Name)</label>
            <input id="machine" name="machine" type="text" placeholder="เช่น เครื่องตัด... / e.g. Cutting machine" required />
          </div>
          <div class="field" data-step="6">
            <label for="desc">รายละเอียดปัญหา (Repair Description)</label>
            <textarea id="desc" name="desc" placeholder="เล่าอาการ/ตำแหน่ง/เงื่อนไขที่พบ (Describe problem / location / condition)" required></textarea>
          </div>
          <div class="field" data-step="7">
            <label for="techType">ประเภทงาน (Technician Department)</label>
            <select id="techType" name="techType" required>
              <option value="" disabled selected>เลือก... / Select...</option>
              <option>Mechanical</option>
              <option>Electrical</option>
              <option>Mold</option>
              <option>PM</option>
            </select>
          </div>
          <div class="field" data-step="8">
            <label for="supervisor">ชื่อพนักงานซ่อม (Supervisor / Technician)</label>
            <input id="supervisor" name="supervisor" type="text" placeholder="เช่น เศรษฐาณณ์ / Optional" />
            <small>ระบุถ้าทราบ (ไม่บังคับ) / Optional field</small>
          </div>

          <button class="btn" type="submit">ส่งคำขอซ่อม <small>Submit request</small></button>
        </form>
        <p class="muted" style="margin-top:10px">
          *โหมดทดสอบ:* ถ้ายังไม่ได้ตั้งค่า <code>WEB_APP_URL</code> ข้อมูลจะถูกเก็บชั่วคราวในเครื่องคุณ;
          หากตั้งค่าแล้ว ระบบจะส่งเข้า <strong>Google Sheets</strong> อัตโนมัติ
        </p>
      </div>
    </section>

    <!-- ============ SUBMIT SUCCESS ============ -->
    <section data-view="success">
      <div class="card" style="text-align:center">
        <h2>การแจ้งซ่อมเสร็จสิ้น (Request Submitted)</h2>
        <p class="muted">ระบบได้บันทึกคำขอไว้แล้ว / Your request has been recorded.</p>
        <div style="display:flex; gap:8px; justify-content:center; margin-top:12px">
          <button class="chip" onclick="go('status')">ดูสถานะ<br><small>View status</small></button>
          <button class="chip" onclick="go('home')">กลับหน้าแรก<br><small>Back to home</small></button>
        </div>
      </div>
    </section>

    <!-- ============ STATUS ============ -->
    <section data-view="status">
      <div class="kpi">
        <div class="box"><b>Scheduled</b><span id="kScheduled">0</span></div>
        <div class="box"><b>Completed</b><span id="kCompleted">0</span></div>
        <div class="box"><b>Overdue</b><span id="kOverdue">0</span></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">รายการคำขอ (Request List)</h3>
        <table id="tbl">
          <thead>
            <tr>
              <th>Date</th>
              <th>Department</th>
              <th>Machine</th>
              <th>Description</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p class="muted" style="margin:10px 0 0">
          *กดสถานะในตารางเพื่อสลับ Scheduled → Completed → Overdue / Click status to toggle
        </p>
      </div>
    </section>

    <!-- ============ POWER BI ============ -->
    <section data-view="powerbi">
      <div class="card">
        <h2 style="margin:0 0 12px">Power BI Dashboard</h2>
        <p class="muted">ใส่ลิงก์ Embed ของ Power BI แทน <code>IFRAME</code> ด้านล่างนี้ / Replace src with your Power BI embed link.</p>
        <div style="display:grid; gap:12px">
          <iframe title="Overview" style="width:100%; aspect-ratio:16/9; border:0; background:#fafafa" src="https://app.powerbi.com/view?r=eyJrIjoiYWM2MDViNTEtNGU4Mi00ODVlLTk4ZmItMzgzMTg1YzdjNDUxIiwidCI6ImY5MGM0NjQ3LTg4NmYtNGI0Yy1iMmViLTU1NWRmOWVjNGU4MSIsImMiOjEwfQ%3D%3D" allowfullscreen></iframe>
          <iframe title="Maintenance Wise" style="width:100%; aspect-ratio:16/9; border:0; background:#fafafa" src="https://app.powerbi.com/view?r=eyJrIjoiYWM2MDViNTEtNGU4Mi00ODVlLTk4ZmItMzgzMTg1YzdjNDUxIiwidCI6ImY5MGM0NjQ3LTg4NmYtNGI0Yy1iMmViLTU1NWRmOWVjNGU4MSIsImMiOjEwfQ%3D%3D" allowfullscreen></iframe>
        </div>
      </div>
    </section>

    <!-- ============ PM (Info) ============ -->
    <section data-view="pm">
      <div class="card">
        <h2 style="margin:0 0 10px">Dashboard : Preventive Maintenance</h2>
        <p>จะแสดงข้อมูลเกี่ยวกับการบำรุงรักษาเชิงป้องกัน (Preventive Maintenance) …</p>
        <ul>
          <li>PM Compliance %, Breakdown hrs, MTBF/MTTR</li>
          <li>แผน PM รายเครื่อง + สถานะล่าสุด</li>
          <li>Top Risks จาก FMEA เชื่อมกับโหมดเสีย</li>
        </ul>
      </div>
    </section>

    <!-- ============ GUIDE ============ -->
    <section data-view="guide">
      <div class="card">
        <h2 style="margin:0 0 10px">คู่มือการใช้งาน (User Guide)</h2>
        <ol>
          <li>กด “แจ้งซ่อม (Repair request)” ใส่รายละเอียด แล้วกดส่ง</li>
          <li>ดูรายการและนับงานใน “สถานะการแจ้งซ่อม (Request status)”</li>
          <li>ฝังรายงานจริงใน “Power BI Dashboard” ด้วยลิงก์ Embed</li>
          <li>ปรับชื่อแผนก/ชนิดงาน/ชื่อเครื่องได้จากรายการในฟอร์ม</li>
        </ol>
        <p class="muted">*ไฟล์นี้เป็น Single-File HTML — อัปโหลดขึ้น Google Drive/เว็บเซิร์ฟเวอร์แล้วเปิดใช้งานได้ทันที</p>
      </div>
    </section>
  </main>

  <!-- Quick tabs for demo -->
  <div class="tabbar">
    <div class="inner">
      <button class="chip" onclick="go('home')">Home<br><small>หน้าแรก</small></button>
      <button class="chip" onclick="go('report')">แจ้งซ่อม<br><small>Repair</small></button>
      <button class="chip" onclick="go('status')">สถานะ<br><small>Status</small></button>
      <button class="chip" onclick="go('powerbi')">Power BI<br><small>Dashboard</small></button>
      <button class="chip" onclick="go('guide')">คู่มือ<br><small>Guide</small></button>
    </div>
  </div>

  <script>
    /* ===== Config ===== */
    const APP_NAME   = 'DATA';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbypCAC7GHGiZ9sN-3krJ4Eeq_0-0AdnnmwTGnRSKL_PIrfX70FagGunBQd5xDW5cevZ4A/exec';
    const API_TOKEN   = '65109010093';

    /* ===== Router ===== */
    const titleMap = {
      home:"Maintenance",
      report:"การแจ้งซ่อม",
      success:"การแจ้งซ่อม",
      status:"สถานะการแจ้งซ่อม",
      powerbi:"Power BI",
      pm:"Preventive Maintenance",
      guide:"คู่มือการใช้งาน"
    };
    function show(view){
      document.querySelectorAll('[data-view]').forEach(el=>el.classList.remove('active'));
      const el = document.querySelector(`[data-view="${view}"]`);
      el?.classList.add('active');
      document.getElementById('title').textContent = titleMap[view]||'Maintenance';
      document.title = `${titleMap[view]||'Maintenance'} · ${APP_NAME}`;
      history.replaceState(null, '', `#${view}`);
      window.scrollTo({top:0, behavior:'smooth'});
      if(view==='status') renderTable();
    }
    function go(view){ show(view); }
    window.addEventListener('load',()=>{ const initial = location.hash?.slice(1) || 'home'; show(initial); });

    /* ===== Local fallback (demo) ===== */
    const DEMO = !/^https?:\/\//i.test(WEB_APP_URL);
    const KEY='tickets.v1';
    const getTickets=()=>JSON.parse(localStorage.getItem(KEY)||'[]');
    const setTickets=(v)=>localStorage.setItem(KEY,JSON.stringify(v));

    /* ===== API helpers (Google Apps Script) ===== */
    async function fetchJSON(url, options){
      const res = await fetch(url, options);
      const text = await res.text();
      try{ return JSON.parse(text); }
      catch(e){ throw new Error(`Bad response (${res.status}): ${text.slice(0,200)}`); }
    }
    async function apiCreateTicket(payload){
      const body = new URLSearchParams({ action:'create', token: API_TOKEN, ...payload }).toString();
      return fetchJSON(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    }
    async function apiListTickets(limit=500){
      return fetchJSON(`${WEB_APP_URL}?action=list&limit=${limit}`);
    }
    async function apiUpdateStatus(id, status){
      const body = new URLSearchParams({ action:'updateStatus', id, status, token: API_TOKEN }).toString();
      return fetchJSON(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    }

    /* ===== Submit form ===== */
    document.getElementById('ticketForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const payload = {
        reqDate: data.reqDate, reqTime: data.reqTime, assigned: data.assigned,
        dept: data.dept, machine: data.machine, desc: data.desc,
        techType: data.techType, supervisor: data.supervisor, status: 'Scheduled'
      };

      try{
        if(DEMO){
          const ticket = {
            id: Date.now().toString(36),
            date: data.reqDate,
            time: data.reqTime,
            assigned: data.assigned,
            dept: data.dept,
            machine: data.machine,
            desc: data.desc,
            techType: data.techType,
            supervisor: data.supervisor,
            status: 'Scheduled'
          };
          const all = getTickets(); all.unshift(ticket); setTickets(all);
          e.target.reset(); go('success');
        }else{
          const r = await apiCreateTicket(payload);
          if(r.ok){ e.target.reset(); go('success'); }
          else{ alert('บันทึกไม่สำเร็จ: '+(r.error||'unknown')); }
        }
      }catch(err){ alert('เครือข่ายผิดพลาด: ' + err.message); }
    });

    /* ===== Render table ===== */
    async function renderTable(){
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = DEMO ? '' : '<tr><td colspan="5">Loading...</td></tr>';

      let rows = [];
      if(DEMO){
        rows = getTickets();
      }else{
        try{
          const r = await apiListTickets(500);
          rows = (r.rows||[]).map(x=>({
            id: x['ID'],
            date: x['Request Date'],
            dept: x['Machine Department'],
            machine: x['Machine Name'],
            desc: x['Problem Description'],
            status: x['Status']||'Scheduled'
          }));
        }
        catch(e){
          tbody.innerHTML = '<tr><td colspan="5">Load failed</td></tr>';
          return;
        }
      }

      let s=0,c=0,o=0; tbody.innerHTML='';
      for(const r of rows){
        if(r.status==='Scheduled') s++; else if(r.status==='Completed') c++; else o++;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date||''}</td>
          <td>${r.dept||''}</td>
          <td>${r.machine||''}</td>
          <td>${r.desc||''}</td>
          <td><button class="chip" data-id="${r.id||''}" data-status="${r.status}">${r.status}</button></td>`;
        tbody.appendChild(tr);
      }
      document.getElementById('kScheduled').textContent=s;
      document.getElementById('kCompleted').textContent=c;
      document.getElementById('kOverdue').textContent=o;
    }

    /* ===== Toggle status ===== */
    document.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button.chip[data-id]');
      if(!btn) return;
      const cycle = { 'Scheduled':'Completed', 'Completed':'Overdue', 'Overdue':'Scheduled' };
      const id = btn.getAttribute('data-id');
      const next = cycle[btn.dataset.status] || 'Scheduled';

      if(DEMO){
        const all = getTickets();
        const t = all.find(x=>x.id===id);
        if(t){ t.status = next; setTickets(all); renderTable(); }
      }else{
        try{
          const r = await apiUpdateStatus(id, next);
          if(r.ok) renderTable(); else alert('อัปเดตไม่สำเร็จ');
        }
        catch(err){
          alert('เครือข่ายผิดพลาด: ' + err.message);
        }
      }
    });
  </script>
</body>
</html>

