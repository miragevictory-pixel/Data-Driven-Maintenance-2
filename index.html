<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maintenance Portal</title>

  <style>
    :root{
      --brand:#9e2f1c;
      --bg:#fff9f7;
      --text:#1e1e1e;
      --muted:#6b6b6b;
      --card:#ffffff;
      --radius:18px;
      --shadow:0 6px 18px rgba(0,0,0,.12);
    }
    * , *::before, *::after{ box-sizing:border-box; }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "TH Sarabun New", Tahoma, sans-serif;
      color:var(--text);
      background:var(--bg);
      font-size:16px;
      line-height:1.5;
    }

    /* ====== Top Bar ====== */
    .topbar{
      position:sticky; top:0; z-index:20;
      background:var(--brand); color:#fff;
      padding:14px 18px;
      display:flex; align-items:center; gap:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    .topbar h1{
      font-size:20px;
      margin:0;
      font-weight:800;
      letter-spacing:.3px
    }
    .back{
      appearance:none; border:0; cursor:pointer;
      width:40px; height:40px; border-radius:999px;
      display:grid; place-items:center;
      color:#fff;
      background: rgba(255,255,255,.14);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.18),
        0 6px 14px rgba(0,0,0,.18);
      font-size:20px; line-height:1;
      transition: transform .08s ease, background .15s ease, box-shadow .15s ease;
    }
    .back:hover{
      background: rgba(255,255,255,.22);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.22),
        0 10px 20px rgba(0,0,0,.22);
      transform: translateY(-1px);
    }
    .back:active{
      transform: translateY(1px) scale(.98);
      background: rgba(0,0,0,.12);
      box-shadow:
        inset 0 2px 8px rgba(0,0,0,.25),
        0 4px 10px rgba(0,0,0,.15);
    }
    .back:focus-visible{
      outline: none;
      box-shadow:
        0 0 0 3px rgba(255,255,255,.30),
        0 0 0 6px rgba(0,0,0,.12),
        inset 0 0 0 1px rgba(255,255,255,.22);
    }

    /* Container */
    .container{
      max-width: 520px;
      margin:0 auto;
      padding: 22px 18px 78px;
    }
    @media (min-width: 640px){ .container{ max-width: 920px; } }
    @media (min-width: 1024px){
      .container{ max-width: 1240px; padding: 28px 26px 40px; }
    }

    /* Views */
    [data-view]{display:none}
    [data-view].active{display:block}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      margin:18px 0;
    }
    .muted{color:var(--muted)}

    /* Home */
    .hero{ width:100%; text-align:center; margin: 18px 0 18px; }
    .hero span{
      font-size: 44px;
      font-weight: 900;
      color:var(--brand);
      letter-spacing:0.6px;
    }
    .menu{
      display:flex;
      flex-direction:column;
      gap:18px;
      margin-top:14px;
      max-width: 760px;
      margin-left:auto;
      margin-right:auto;
    }
    .btn{
      display:block;
      width:100%;
      text-align:center;
      text-decoration:none;
      cursor:pointer;
      background:var(--brand);
      color:#fff;
      border:0;
      border-radius:999px;
      padding: 14px 22px;
      font-weight:900;
      box-shadow:0 4px 0 #5f1c11, var(--shadow);
      transition:transform .05s ease;
    }
    .btn small{
      display:block;
      font-weight:700;
      font-size: 15px;
      opacity:.92;
      margin-top:2px;
    }
    .btn:active{transform:translateY(1px)}
    @media (min-width: 1024px){
      .hero span{ font-size: 52px; }
      .btn{ padding: 16px 24px; font-size: 18px; }
      .btn small{ font-size: 16px; }
    }

    /* Form */
    form{display:grid; gap:14px}
    .field{display:grid; gap:8px; position:relative}
    .field label{ font-weight:800; font-size:18px; line-height:1.35; }
    .field small{color:var(--muted)}
    .field input,.field select,.field textarea{
      width:100%;
      border-radius:12px;
      border:1px solid #ddd;
      padding:12px 12px;
      font-size:16px;
      background:#fff;
      outline-color:var(--brand);
    }
    .field textarea{min-height:110px; resize:vertical}

    /* Status */
    .kpi{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      margin: 10px 0 14px;
    }
    .kpi .box{
      background:#fff;
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px 14px;
      text-align:center;
    }
    .kpi .box b{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .kpi .box span{
      font-size:28px;
      font-weight:900;
      color:var(--brand);
      line-height:1;
    }

    .tableWrap{ overflow:auto; }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
      min-width: 980px; /* ให้ตารางอ่านง่ายบน PC */
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid #eee;
      vertical-align:top
    }
    th{
      background:#fafafa;
      text-align:left;
      color:#444;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #eee;
      background:#fff;
      font-weight:800;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:#bbb;
    }
    .dot.scheduled{ background:#b23a2a; }
    .dot.completed{ background:#1c8c4a; }
    .dot.overdue{ background:#d08a00; }

    .actionBtn{
      border:0;
      cursor:pointer;
      border-radius:999px;
      padding:8px 14px;
      font-weight:900;
      background:#f3e6e3;
      color:var(--brand);
    }
    .actionBtn:active{ transform: translateY(1px); }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width:min(720px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.30);
      padding:18px;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .modalHeader h3{
      margin:0;
      font-size:18px;
    }
    .closeBtn{
      appearance:none; border:0; cursor:pointer;
      width:38px; height:38px; border-radius:12px;
      background:#f3f3f3;
      font-size:18px;
    }
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){
      .modalGrid{ grid-template-columns: 1fr; }
      table{ min-width: 980px; }
    }

    .rowActions{
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
      margin-top:14px;
    }
    .secondaryBtn{
      border:1px solid #ddd;
      background:#fff;
      border-radius:999px;
      padding:10px 16px;
      font-weight:900;
      cursor:pointer;
    }
    .primaryBtn{
      border:0;
      background:var(--brand);
      color:#fff;
      border-radius:999px;
      padding:10px 16px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 4px 0 #5f1c11;
    }
    .primaryBtn:active{ transform: translateY(1px); }

    /* Footer (mobile) */
    .tabbar{
      position:fixed;
      bottom:14px; left:0; right:0;
      display:flex;
      justify-content:center;
      pointer-events:none
    }
    .tabbar .inner{
      pointer-events:auto;
      background:#fff;
      border-radius:999px;
      box-shadow:var(--shadow);
      display:flex;
      gap:8px;
      padding:8px
    }
    .chip{
      border-radius:999px;
      padding:8px 12px;
      border:1px solid #eee;
      background:#fff;
      font-weight:800;
      cursor:pointer;
      font-size:13px
    }
    .chip small{
      display:block;
      font-weight:500;
      font-size:11px;
      opacity:.85;
    }
    @media (min-width: 1024px){ .tabbar{ display:none; } }

    code{ background:#f5f5f5; padding:2px 6px; border-radius:8px; }
  </style>
</head>

<body>
  <div class="topbar">
    <button class="back" aria-label="ย้อนกลับ" onclick="go('home')">⟵</button>
    <h1 id="title">Maintenance</h1>
  </div>

  <main class="container">
    <!-- HOME -->
    <section data-view="home" class="active">
      <div class="hero"><span>Maintenance</span></div>
      <div class="menu">
        <button class="btn" onclick="go('report')">แจ้งซ่อม <small>Repair request</small></button>
        <button class="btn" onclick="go('status')">สถานะการแจ้งซ่อม <small>Request status</small></button>
      </div>
    </section>

    <!-- REPORT -->
    <section data-view="report">
      <div class="card">
        <h2 style="margin:0 0 8px">การแจ้งซ่อม (Repair Request)</h2>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin: 10px 0 14px;">
          <div class="field">
            <label>Date request (Auto)</label>
            <input id="RequestDateShow" type="text" disabled />
            <small>ระบบสร้างให้อัตโนมัติ</small>
          </div>
          <div class="field">
            <label>Time request (Auto)</label>
            <input id="TimeREquestShow" type="text" disabled />
            <small>ระบบสร้างให้อัตโนมัติ</small>
          </div>
        </div>

        <form id="ticketForm">
          <div class="field">
            <label for="dept">Machine section</label>
            <select id="dept" name="dept" required>
              <option value="" disabled selected>เลือก... / Select...</option>
              <option>P3/1</option>
              <option>P3/2</option>
              <option>P3/3</option>
              <option>P4/1</option>
            </select>
          </div>

          <div class="field">
            <label for="machine">Machine</label>
            <input id="machine" name="machine" type="text" placeholder="เช่น เครื่องตัด... / e.g. Cutting machine" required />
          </div>

          <div class="field">
            <label for="desc">Repairdescription</label>
            <textarea id="desc" name="desc" placeholder="เล่าอาการ/ตำแหน่ง/เงื่อนไขที่พบ (Describe problem / location / condition)" required></textarea>
          </div>

          <div class="field">
            <label for="preorder">Pre order (Optional)</label>
            <input id="preorder" name="preorder" type="text" placeholder="ถ้ามีให้กรอก (Optional)" />
          </div>

          <div class="field">
            <label for="assignedTo">Assigned (Optional)</label>
            <input id="assignedTo" name="assignedTo" type="text" placeholder="ชื่อช่าง/ผู้รับงาน (Optional)" />
          </div>

          <div class="field">
            <label>Status (Auto)</label>
            <input type="text" value="Scheduled" disabled />
            <small>สถานะเริ่มต้นเป็น Scheduled</small>
          </div>

          <button class="btn" type="submit">ส่งคำขอซ่อม <small>Submit request</small></button>
        </form>

        <p class="muted" style="margin-top:12px">
          *หมายเหตุ:* ระบบจะสร้าง <code>Work Order No.</code> อัตโนมัติ (เช่น WO-20260205-1234)
        </p>
      </div>
    </section>

    <!-- SUCCESS -->
    <section data-view="success">
      <div class="card" style="text-align:center">
        <h2>บันทึกสำเร็จ (Request Submitted)</h2>
        <p class="muted">ระบบได้บันทึกคำขอไว้แล้ว</p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:14px; flex-wrap:wrap">
          <button class="chip" onclick="go('status')">ดูสถานะ<br><small>View status</small></button>
          <button class="chip" onclick="go('home')">กลับหน้าแรก<br><small>Back to home</small></button>
        </div>
      </div>
    </section>

    <!-- STATUS -->
    <section data-view="status">
      <div class="kpi">
        <div class="box"><b>Scheduled</b><span id="kScheduled">0</span></div>
        <div class="box"><b>Completed</b><span id="kCompleted">0</span></div>
        <div class="box"><b>Overdue</b><span id="kOverdue">0</span></div>
      </div>

      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <h3 style="margin:0; font-size:20px">รายการคำขอ (Request List)</h3>
          <button class="actionBtn" onclick="renderTable()">Refresh</button>
        </div>

        <div class="tableWrap" style="margin-top:12px;">
          <table id="tbl">
            <thead>
              <tr>
                <th>WorkOrderNo</th>
                <th>RequestDate</th>
                <th>Time</th>
                <th>Machine Section</th>
                <th>Machine</th>
                <th>Description</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <p class="muted" style="margin:12px 0 0">
          *กด <b>Update</b> เฉพาะงานที่เป็น Scheduled เพื่อกรอก Supervisor / Time to repair / Department แล้วระบบจะเปลี่ยนเป็น Completed
        </p>
      </div>
    </section>
  </main>

  <!-- Update Modal -->
  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHeader">
        <h3 id="modalTitle">Update งานซ่อม</h3>
        <button class="closeBtn" onclick="closeModal()">✕</button>
      </div>

      <div class="muted" id="modalSub" style="margin-bottom:10px;"></div>

      <div class="modalGrid">
        <div class="field">
          <label for="mSupervisor">Supervisor</label>
          <input id="mSupervisor" type="text" placeholder="ชื่อผู้ตรวจ/หัวหน้า" />
        </div>

        <div class="field">
          <label for="mDepartment">Department</label>
          <select id="mDepartment">
            <option value="" selected disabled>เลือก... / Select...</option>
            <option>Mechanical</option>
            <option>Electrical</option>
            <option>Mold</option>
            <option>PM</option>
          </select>
        </div>

        <div class="field">
          <label for="mTimeToRepair">Time to repair (min)</label>
          <input id="mTimeToRepair" type="number" min="0" placeholder="เช่น 30" />
          <small>ใส่เป็นนาที (ตัวเลข)</small>
        </div>

        <div class="field">
          <label for="mWorkOrderNo">Work Order No.</label>
          <input id="mWorkOrderNo" type="text" disabled />
          <small>อ้างอิงเอกสาร</small>
        </div>
      </div>

      <div class="rowActions">
        <button class="secondaryBtn" onclick="closeModal()">Cancel</button>
        <button class="primaryBtn" onclick="submitUpdate()">Save & Complete</button>
      </div>
    </div>
  </div>

  <!-- Mobile tabbar -->
  <div class="tabbar">
    <div class="inner">
      <button class="chip" onclick="go('home')">Home<br><small>หน้าแรก</small></button>
      <button class="chip" onclick="go('report')">แจ้งซ่อม<br><small>Repair</small></button>
      <button class="chip" onclick="go('status')">สถานะ<br><small>Status</small></button>
    </div>
  </div>

  <script>
    /************* CONFIG (แก้ตรงนี้) *************/
    const APP_NAME    = 'Centralized Database from factory';

    // ✅ ใส่ “Web app URL” เท่านั้น (อย่าใช้ Library URL)
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxoGPh-Q175O0rfbm0tA8B6tjb5TSvVgPxmuZ0CqI79wUP8zuEqbBWsJj5sYPTdiQaljA/exec';

    // ✅ ใส่ token ให้ตรงกับ Apps Script
    const API_TOKEN   = '0992183266';

    /************* ROUTER *************/
    const titleMap = {
      home:"Maintenance",
      report:"การแจ้งซ่อม",
      success:"การแจ้งซ่อม",
      status:"สถานะการแจ้งซ่อม"
    };

    function show(view){
      document.querySelectorAll('[data-view]').forEach(el=>el.classList.remove('active'));
      const el = document.querySelector(`[data-view="${view}"]`);
      if (el) el.classList.add('active');

      document.getElementById('title').textContent = titleMap[view] || 'Maintenance';
      document.title = `${titleMap[view] || 'Maintenance'} · ${APP_NAME}`;
      history.replaceState(null, '', `#${view}`);
      window.scrollTo({top:0, behavior:'smooth'});

      if(view === 'report') setAutoDateTime();
      if(view === 'status') renderTable();
    }
    function go(view){ show(view); }

    window.addEventListener('load', () => {
      const initial = (location.hash || '#home').slice(1);
      show(initial);
    });

    /************* DATETIME + WORK ORDER NO *************/
    function pad2(n){ return String(n).padStart(2,'0'); }

    function setAutoDateTime(){
      const now = new Date();
      const RequestDate = now.toLocaleDateString('en-CA'); // YYYY-MM-DD
      const TimeREquest = now.toTimeString().slice(0,5);   // HH:MM
      document.getElementById('RequestDateShow').value = RequestDate;
      document.getElementById('TimeREquestShow').value = TimeREquest;
    }

    // สร้าง Work Order No. แบบง่าย: WO-YYYYMMDD-XXXX
    function generateWorkOrderNo(){
      const now = new Date();
      const y = now.getFullYear();
      const m = pad2(now.getMonth()+1);
      const d = pad2(now.getDate());
      const rand = Math.floor(1000 + Math.random()*9000); // 4 digits
      return `WO-${y}${m}${d}-${rand}`;
    }

    /************* HTTP HELPERS *************/
    async function fetchJSON(url, options){
      const res = await fetch(url, options);
      const text = await res.text();
      try { return JSON.parse(text); }
      catch(e){ throw new Error(`Bad response (${res.status}): ${text.slice(0,200)}`); }
    }

    async function apiCreateTicket(payload){
      const body = new URLSearchParams({ action:'create', token: API_TOKEN, ...payload }).toString();
      return fetchJSON(WEB_APP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body
      });
    }

    async function apiListTickets(limit=500){
      return fetchJSON(`${WEB_APP_URL}?action=list&limit=${limit}`);
    }

    // ✅ สำคัญ: action ต้องเป็น updateTicket และต้องส่ง id
    async function apiUpdateTicket(id, payload){
      const body = new URLSearchParams({
        action:'updateTicket',
        token: API_TOKEN,
        id,
        ...payload
      }).toString();

      return fetchJSON(WEB_APP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body
      });
    }

    /************* SUBMIT FORM (CREATE) *************/
    document.getElementById('ticketForm').addEventListener('submit', async (e)=>{
      e.preventDefault();

      const dept = document.getElementById('dept').value.trim();
      const machine = document.getElementById('machine').value.trim();
      const desc = document.getElementById('desc').value.trim();
      const preorder = document.getElementById('preorder').value.trim();
      const assigned = document.getElementById('assignedTo').value.trim();

      if(!dept || !machine || !desc){
        alert('กรุณากรอกข้อมูลให้ครบ (Machine section / Machine / Repairdescription)');
        return;
      }

      const now = new Date();
      const RequestDate = now.toLocaleDateString('en-CA');
      const TimeREquest = now.toTimeString().slice(0,5);
      const workOrderNo = generateWorkOrderNo();

      const payload = {
        RequestDate,
        TimeREquest,
        "Machine Section": dept,
        Machine: machine,
        Repairdescription: desc,
        "Pre order": preorder,
        Assigned: assigned,
        Department: '',           // ยังไม่ต้องกรอกตอนแจ้ง
        Supervisor: '',           // ยังไม่ต้องกรอกตอนแจ้ง
        "Work Order No.": workOrderNo,
        "Time to repair": '',
        ScheduledDate: '',
        Status: 'Scheduled'
      };

      try{
        const r = await apiCreateTicket(payload);
        if(r.ok){
          e.target.reset();
          go('success');
        }else{
          alert('บันทึกไม่สำเร็จ: ' + (r.error || 'unknown'));
        }
      }catch(err){
        alert('เครือข่ายผิดพลาด: ' + err.message + '\n\nเช็คว่า Web app เปิดสิทธิ์ถูกต้อง และ WEB_APP_URL ถูกต้อง');
      }
    });

    /************* RENDER TABLE *************/
    function escapeHtml(str){
      return String(str ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function statusDotClass(s){
      s = String(s||'').toLowerCase();
      if(s === 'scheduled') return 'scheduled';
      if(s === 'completed') return 'completed';
      if(s === 'overdue') return 'overdue';
      return '';
    }

    async function renderTable(){
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';

      let rows = [];
      try{
        const r = await apiListTickets(500);
        rows = r.rows || [];
      }catch(e){
        tbody.innerHTML = '<tr><td colspan="8">Load failed (เช็ค WEB_APP_URL / สิทธิ์ Web app)</td></tr>';
        return;
      }

      // KPI
      let s=0,c=0,o=0;

      tbody.innerHTML = '';
      for(const x of rows){
        const id = x['ID'] || '';
        const requestDate = x['RequestDate'] || '';
        const timeReq = x['TimeREquest'] || '';
        const section = x['Machine Section'] || '';
        const machine = x['Machine'] || '';
        const desc = x['Repairdescription'] || '';
        const status = x['Status'] || 'Scheduled';
        const workOrderNo = x['Work Order No.'] || '';

        if(status === 'Scheduled') s++;
        else if(status === 'Completed') c++;
        else if(status === 'Overdue') o++;

        const canUpdate = (status === 'Scheduled');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(workOrderNo)}</td>
          <td>${escapeHtml(requestDate)}</td>
          <td>${escapeHtml(timeReq)}</td>
          <td>${escapeHtml(section)}</td>
          <td>${escapeHtml(machine)}</td>
          <td>${escapeHtml(desc)}</td>
          <td>
            <span class="pill">
              <span class="dot ${statusDotClass(status)}"></span>
              ${escapeHtml(status)}
            </span>
          </td>
          <td>
            ${canUpdate
              ? `<button class="actionBtn" data-action="openUpdate" data-id="${escapeHtml(id)}">Update</button>`
              : '—'
            }
          </td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById('kScheduled').textContent = s;
      document.getElementById('kCompleted').textContent = c;
      document.getElementById('kOverdue').textContent = o;
    }

    /************* UPDATE MODAL LOGIC *************/
    let currentUpdateId = null;
    let currentUpdateWorkOrder = '';

    function openModal({id, workOrderNo, summary}){
      currentUpdateId = id;
      currentUpdateWorkOrder = workOrderNo || '';
      document.getElementById('mWorkOrderNo').value = currentUpdateWorkOrder;
      document.getElementById('mSupervisor').value = '';
      document.getElementById('mDepartment').value = '';
      document.getElementById('mTimeToRepair').value = '';

      document.getElementById('modalSub').textContent = summary || '';
      const bd = document.getElementById('modalBackdrop');
      bd.classList.add('show');
      bd.setAttribute('aria-hidden','false');
    }

    function closeModal(){
      currentUpdateId = null;
      const bd = document.getElementById('modalBackdrop');
      bd.classList.remove('show');
      bd.setAttribute('aria-hidden','true');
    }

    async function submitUpdate(){
      if(!currentUpdateId){
        alert('ไม่พบ ID สำหรับอัปเดต');
        return;
      }
      const supervisor = document.getElementById('mSupervisor').value.trim();
      const department = document.getElementById('mDepartment').value;
      const timeToRepair = document.getElementById('mTimeToRepair').value.trim();

      if(!supervisor || !department || !timeToRepair){
        alert('กรุณากรอก Supervisor / Department / Time to repair ให้ครบ');
        return;
      }

      try{
        const r = await apiUpdateTicket(currentUpdateId, {
          supervisor,
          department,
          timeToRepair,
          status: 'Completed',
          forceCompleted: '1'
        });

        if(r.ok){
          closeModal();
          await renderTable();
        }else{
          alert('อัปเดตไม่สำเร็จ: ' + (r.error || 'unknown'));
        }
      }catch(err){
        alert('เครือข่ายผิดพลาด: ' + err.message);
      }
    }

    /************* CLICK HANDLERS *************/
    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-action="openUpdate"]');
      if(!btn) return;

      const id = btn.getAttribute('data-id');
      // หาแถวเพื่อดึง workOrder + summary
      const tr = btn.closest('tr');
      const tds = tr ? tr.querySelectorAll('td') : [];
      const workOrderNo = tds[0]?.textContent?.trim() || '';
      const requestDate = tds[1]?.textContent?.trim() || '';
      const timeReq = tds[2]?.textContent?.trim() || '';
      const section = tds[3]?.textContent?.trim() || '';
      const machine = tds[4]?.textContent?.trim() || '';

      const summary = `WO: ${workOrderNo} | ${requestDate} ${timeReq} | ${section} | ${machine}`;
      openModal({ id, workOrderNo, summary });
    });

    // ปิด modal เมื่อคลิกพื้นหลัง
    document.getElementById('modalBackdrop').addEventListener('click', (ev)=>{
      if(ev.target.id === 'modalBackdrop') closeModal();
    });
  </script>
</body>
</html>



